<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci칩n</title>
        <link rel="icon" type="image/png" href="img/logo.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/dash.css">
    <link rel="stylesheet" href="css/tipografia.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="js/fivernimda.js"></script>
   
   
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <h2>Admin Panel</h2>
            </div>
<ul class="nav-menu">
    
    <li class="nav-item active" data-tab="dashboard">
        <i class="fas fa-tachometer-alt"></i> Dashboard
    </li>
    <li class="nav-item nav-link-external" data-href="index.html">
       <i class="fas fa-home"></i> modo usuario
    </li>
     <li class="nav-item nav-link-external" data-href="admin1.html">
        <i class="fas fa-shopping-cart"></i> Pedidos
    </li>
    <li class="nav-item" data-tab="products">
        <i class="fas fa-box-open"></i> Productos
    </li>
    <li class="nav-item" data-tab="configuration">
        <i class="fas fa-cog"></i> Configuraci칩n de carruseles
    </li>
    <li class="nav-item" data-tab="banners">
        <i class="fas fa-image"></i>Banner dia especial
    </li>
    <li class="nav-item" data-tab="carousel">
        <i class="fas fa-images"></i> Carrusel de anuncios
    </li>
    <li class="nav-item" data-tab="special-catalog">
        <i class="fas fa-star"></i> Cat치logo Especial
    </li>
    <li class="nav-item" data-tab="adiciones-content">
        <i class="fas fa-plus-circle"></i> Adiciones
    </li>
   
    <li class="nav-item" data-tab="globos-content">
       <i class="fas fa-circle"></i> Globos
    </li>
    <li class="nav-item" data-tab="dias-clausurados">
    <i class="fas fa-calendar-times"></i> D칤as Clausurados
</li>
 <li class="nav-item" data-tab="lazos-content">
        <i class="fas fa-ribbon"></i> Lazos
    </li>
    
    <li class="nav-item" data-tab="sorprende-content">
        <i class="fas fa-heart"></i> Sorprende a los que quieres
    </li>

    <li class="nav-item nav-link-external" data-href="subir.html">
       <i class="fas fa-upload"></i> Subir fotos
     </li>
     <li class="nav-item" data-tab="top-buyers">
    <i class="fas fa-crown"></i> Compradores Top
</li>

</ul>
        </div>
        
        <div class="main-content">
            <div class="header">
                <h1 id="page-title">Dashboard</h1>
                <div class="user-info">
                    <img src="https://pub-2c0010c6ef454c3a8dd9b573f70a17f4.r2.dev/logo-moretina/profile.jpg" alt="User">
                    <span id="admin-name"></span>
                </div>
            </div>
            
            <!-- Dashboard Tab -->
            <div class="tab-content active" id="dashboard">
                <div class="stats-container">
                    <div class="stat-card">
                        <h3>Pedidos Totales</h3>
                        <div class="value" id="total-orders">0</div>
                        <div class="change up">
                            <i class="fas fa-arrow-up"></i> <span id="orders-change">0%</span> vs 칰ltimo mes
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>Ingresos Totales</h3>
                        <div class="value" id="total-revenue">$0</div>
                        <div class="change up">
                            <i class="fas fa-arrow-up"></i> <span id="revenue-change">0%</span> vs 칰ltimo mes
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>Pedidos Pendientes</h3>
                        <div class="value" id="pending-orders">0</div>
                        <div class="change down">
                            <i class="fas fa-arrow-down"></i> <span id="pending-change">0%</span> vs 칰ltimo mes
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>Productos Vendidos</h3>
                        <div class="value" id="sold-products">0</div>
                        <div class="change up">
                            <i class="fas fa-arrow-up"></i> <span id="products-change">0%</span> vs 칰ltimo mes
                        </div>
                    </div>
                </div>
                
                <div class="charts-container">
                    <div class="chart-card">
                        <h2>Ventas Mensuales</h2>
                        <canvas id="sales-chart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h2>Pedidos por Estado</h2>
                        <canvas id="orders-chart"></canvas>
                    </div>
                </div>
                
                <div class="table-container">
                    <h2>칔ltimos Pedidos</h2>
                    <table id="recent-orders">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th>Estado</th>
                              
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Las filas se llenar치n con JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
           
            
            <!-- Products Tab -->
            <div class="tab-content" id="products">
                <div class="tab-container">
                    <div class="tabs">
                    <div class="tabs">
    <div class="tab active" data-product-tab="all">Todos</div>
    <div class="tab" data-product-tab="arreglos">Arreglos</div>
    <div class="tab" data-product-tab="box">Box</div>
    <div class="tab" data-product-tab="fresas">Fresas</div>
    <div class="tab" data-product-tab="frutales">Frutales</div>
    <div class="tab" data-product-tab="desayunos">Desayunos</div>
        <div class="tab" data-product-tab="diaespecial">catalogo especial</div>
        <div class="tab" data-product-tab="promociones">promociones</div>

</div>
                        <button class="btn btn-primary" style="margin-left: auto;" id="add-product-btn">
                            <i class="fas fa-plus"></i> Agregar Producto
                        </button>
                    </div>
                </div>
                
                <div class="product-grid" id="products-grid">
                    <!-- Los productos se llenar치n con JavaScript -->
                </div>
            </div>
            



            <!-- Lazos Tab -->
<div class="tab-content" id="lazos-content">
    <div class="table-container">
        <div class="products-header">
            <h2>Gesti칩n de Lazos</h2>
            <button id="add-lazo-btn" class="btn btn-primary">
                <i class="fas fa-plus"></i> Agregar Lazo
            </button>
        </div>
        
        <div class="products-nav">
            <button class="nav-btn active" data-lazo-tab="all">Todos los Lazos</button>
        </div>
        
        <div id="lazos-grid" class="products-grid">
            <!-- Los lazos aparecer치n aqu칤 -->
        </div>
    </div>
</div>

<!-- Sorprende Tab -->
<div class="tab-content" id="sorprende-content">
    <div class="table-container">
        <div class="products-header">
            <h2>Gesti칩n de Sorprende a los que quieres</h2>
            <button id="add-sorprende-btn" class="btn btn-primary">
                <i class="fas fa-plus"></i> Agregar Imagen
            </button>
        </div>
        
        <div class="products-nav">
            <button class="nav-btn active" data-sorprende-tab="all">Todas las Im치genes</button>
        </div>
        
        <div id="sorprende-grid" class="products-grid">
            <!-- Las im치genes aparecer치n aqu칤 -->
        </div>
    </div>
</div>


<!-- D칤as Clausurados Tab -->
<div class="tab-content" id="dias-clausurados">
    <div class="table-container">
        <div class="products-header">
            <h2>Gesti칩n de D칤as Clausurados</h2>
            <button id="add-dia-clausurado-btn" class="btn btn-primary">
                <i class="fas fa-plus"></i> Agregar D칤a Clausurado
            </button>
        </div>
        
        <div class="products-nav">
            <button class="nav-btn active" data-dia-tab="all">Todos los D칤as Clausurados</button>
        </div>
        
        <div id="dias-clausurados-grid" class="products-grid">
            <!-- Los d칤as clausurados aparecer치n aqu칤 -->
        </div>
    </div>
</div>



<!-- Top Buyers Tab -->
<div class="tab-content" id="top-buyers">
    <div class="table-container">
        <h2>Compradores Top</h2>
        
        <!-- Comprador Top Destacado -->
        <div id="top-buyer-highlight" class="top-buyer-highlight">
            <!-- Se llenar치 con JavaScript -->
        </div>
        
        <!-- Lista de todos los compradores -->
        <div class="buyers-list-container">
            <h3>Todos los Compradores</h3>
            <div id="all-buyers-list" class="all-buyers-list">
                <!-- Se llenar치 con JavaScript -->
            </div>
        </div>
    </div>
</div>
<!-- Special Catalog Tab -->
<div class="tab-content" id="special-catalog">
    <div class="table-container">
        <h2>Control del Cat치logo Especial</h2>
        
        <div class="admin-control-card">
            <h3><i class="fas fa-lock-open"></i> Estado del Cat치logo</h3>
            
            <div class="control-item">
                <label class="switch">
                    <input type="checkbox" id="toggle-special-catalog">
                    <span class="slider round"></span>
                </label>
                <span id="special-catalog-status">Cargando estado...</span>
            </div>
            
            <div class="control-item">
                <label>Estado actual: </label>
                <span id="special-catalog-current-status" class="status-tag">---</span>
            </div>
            
            <p class="admin-hint">
                Cuando el cat치logo est치 CERRADO, los clientes ver치n un mensaje de no disponible 
                en lugar de los productos especiales.
            </p>
        </div>

        <h2>Mensaje de Cat치logo Cerrado</h2>
<form id="overlay-message-form">
    <div class="form-group">
        <label for="overlay-title-admin">T칤tulo</label>
        <input type="text" class="form-control" id="overlay-title-admin">
    </div>
    <div class="form-group">
        <label for="overlay-message-admin">Mensaje</label>
        <textarea class="form-control" id="overlay-message-admin" rows="3"></textarea>
    </div>  
    <button type="submit" class="btn btn-primary">Guardar</button>
</form>
 

        
    </div>
</div>



            <!-- Configuration Tab -->
            <div class="tab-content" id="configuration">
                <div class="table-container">
                    <h2>Configuraci칩n del Carrusel</h2>
                    <p>
<span>
    Aqu칤 podr치s editar los tres carruseles y el texto que aparece.  
    Haz click aqu칤 para mostrar Paso a Paso
    <a href="https://pub-2c0010c6ef454c3a8dd9b573f70a17f4.r2.dev/explicaciones-no-borrar/explicacion1.png" class="open-ytxd">Ver imagen</a>
  </span><br>
  <p style="color: #ef4444;">NO OLVIDES GUARDAR LOS CAMBIOS DESPUES DE EDITAR</p>
</p><br>
                    <form id="carousel-config-form">
                        <div class="form-group">
                            <label for="carousel1-text">Texto Carrusel 1</label>
                            <input type="text" class="form-control" id="carousel1-text" placeholder="Texto para el carrusel 1">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="carousel1-show-text"> Mostrar Texto
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="carousel1-show-carousel"> Mostrar Carrusel
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label for="carousel2-text">Texto Carrusel 2</label>
                            <input type="text" class="form-control" id="carousel2-text" placeholder="Texto para el carrusel 2">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="carousel2-show-text"> Mostrar Texto
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="carousel2-show-carousel"> Mostrar Carrusel
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label for="carousel3-text">Texto Carrusel 3</label>
                            <input type="text" class="form-control" id="carousel3-text" placeholder="Texto para el carrusel 3">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="carousel3-show-text"> Mostrar Texto
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="carousel3-show-carousel"> Mostrar Carrusel
                            </label>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </form>
                </div>
            </div>
            
            <!-- Banners Tab -->
            <div class="tab-content" id="banners">
                <div class="table-container">
                    <h2>Configuraci칩n del Banner del dia Especial</h2>
                    <span>
    Aqu칤 podras activar o desactivar el banner del dia especial y  cambiar el link la imagen. 
    Haz click aqu칤 para mostrar Paso a Paso
    <a href="https://pub-2c0010c6ef454c3a8dd9b573f70a17f4.r2.dev/explicaciones-no-borrar/explicacion2.png" class="open-ytxd">Ver imagen</a>
  </span><br>
  <p style="color: #ef4444;">NO OLVIDES GUARDAR LOS CAMBIOS DESPUES DE EDITAR</p>
  <p>Dimension unica  760 X 304 Px </p>
</p><br>
                    <form id="banner-config-form">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="banner-active"> Banner Activo
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="banner-link">Enlace del Banner Estatico</label>
                            <input type="text" class="form-control" id="banner-link" placeholder="URL de destino" disabled>
                        </div>
                        <div class="form-group">
                            <label for="banner-pc">Imagen para PC</label>
                            <input type="text" class="form-control" id="banner-pc" placeholder="URL de la imagen para PC">
                        </div>
                        <div class="form-group">
                            <label for="banner-mobile">Imagen para M칩vil</label>
                            <input type="text" class="form-control" id="banner-mobile" placeholder="URL de la imagen para m칩vil">
                        </div>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </form>
                </div>
            </div>


           


                <!-- Carrusel Tab -->
<div class="tab-content" id="carousel">
    <div class="table-container">
        <h2>Administrar Carrusel</h2>
        <span>
    Aqu칤 podr치s editar, eliminar y agregar nuevas im치genes al carrusel del inicio de la pagina 
    ten en cuenta que el carrusel se divide en dos partes: celulares y computadoras. 
    Haz click aqu칤 para mostrar Paso a Paso
    <a href="https://pub-2c0010c6ef454c3a8dd9b573f70a17f4.r2.dev/explicaciones-no-borrar/explicacion4.png" class="open-ytxd">Ver imagen</a>
  </span><br><br>
  <p><SPAn>Dimensiones</SPAn></p>
  <p style="color: #ffffff;">celulares: 2375 X 2484 Px</p>
  <p style="color: #ffffff;">computadoras: 11173 X 5669 Px</p><br>
  
        
        <div class="tab-container">
            <div class="tabs">
                <div class="tab active" data-carousel-tab="desktop">Desktop</div>
                <div class="tab" data-carousel-tab="mobile">Mobile</div>
            </div>
        </div>
        <div id="carousel-desktop-content" class="tab-content active">
            <h3>Im치genes del Carrusel (Desktop)</h3>
            <div id="desktop-carousel-images" class="carousel-images-container active">
                <!-- Las im치genes se cargar치n aqu칤 -->
            </div>
            <button class="btn btn-primary" id="add-desktop-image">
                <i class="fas fa-plus"></i> Agregar Imagen
            </button>
        </div>
        <div id="carousel-default-message" class="carousel-default-text">
    <p>游닞 Selecciona <strong>Desktop</strong> o <strong>Mobile</strong> para gestionar las im치genes del carrusel</p>
</div>

        <div id="carousel-mobile-content" class="tab-content">
            <h3>Im치genes del Carrusel (Mobile)</h3>
            <div id="mobile-carousel-images" class="carousel-images-container">
                <!-- Las im치genes se cargar치n aqu칤 -->
            </div>
            <button class="btn btn-primary" id="add-mobile-image">
                <i class="fas fa-plus"></i> Agregar Imagen
            </button>
        </div>
    </div>
</div>




    <!-- Adiciones Tab -->
<div class="tab-content" id="adiciones-content">
    <div class="table-container">
        <div class="products-header">
            <h2>Gesti칩n de Adiciones</h2>
            <button id="add-adicion-btn" class="btn btn-primary">
                <i class="fas fa-plus"></i> Agregar Adici칩n
            </button>
        </div>
        
        <div class="products-nav">
            <button class="nav-btn active" data-adicion-tab="all">Todas las Adiciones</button>
        </div>
        
        <div id="adiciones-grid" class="products-grid">
            <!-- Las adiciones aparecer치n aqu칤 -->
        </div>
    </div>
</div>

<!-- Globos Tab -->
<div class="tab-content" id="globos-content">
    <div class="table-container">
        <div class="products-header">
            <h2>Gesti칩n de Globos</h2>
            <button id="add-globo-btn" class="btn btn-primary">
                <i class="fas fa-plus"></i> Agregar Globo
            </button>
        </div>
        
        <div class="products-nav">
            <button class="nav-btn active" data-globo-tab="all">Todos los Globos</button>
        </div>
        
        <div id="globos-grid" class="products-grid">
            <!-- Los globos aparecer치n aqu칤 -->
        </div>
    </div>
</div>

<!-- Modal para Adiciones -->
<div id="adicion-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="adicion-modal-title">Agregar Adici칩n</h3>
            <button type="button" id="cancel-adicion-btn" class="close-btn">&times;</button>
        </div>
        <form id="adicion-form">
            <input type="hidden" id="adicion-firebase-key">
            
            <div class="form-group">
                <label for="adicion-nombre">Nombre de la Adici칩n</label>
                <input type="text" class="form-control" id="adicion-nombre" required>
            </div>
            
            <div class="form-group">
                <label for="adicion-descripcion">Descripci칩n</label>
                <textarea class="form-control" id="adicion-descripcion" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label for="adicion-precio">Precio</label>
                <input type="number" class="form-control" id="adicion-precio" step="0.01" required>
            </div>
            
            <div class="form-group">
                <label for="adicion-imagen">URL de la Imagen</label>
                <input type="url" class="form-control" id="adicion-imagen">
            </div>
            
            <div class="modal-actions">
                <button type="button" id="cancel-adicion-btn" class="btn btn-secondary">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Adici칩n</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para Globos -->
<div id="globo-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="globo-modal-title">Agregar Globo</h3>
            <button type="button" id="cancel-globo-btn" class="close-btn">&times;</button>
        </div>
        <form id="globo-form">
            <input type="hidden" id="globo-firebase-key">
            
            <div class="form-group">
                <label for="globo-nombre">Nombre del Globo</label>
                <input type="text" class="form-control" id="globo-nombre" required>
            </div>
            
            <div class="form-group">
                <label for="globo-precio">Precio estatico debe ser 4500 </label>
                <input type="number" class="form-control" id="globo-precio" step="0.01" required>
            </div>
            <div class="form-group">
    <label for="globo-tipo">Tipo de Globo</label>
    <select class="form-control" id="globo-tipo" required>
        <option value="">Selecciona un tipo</option>
        <option value="metalizado">Metalizado</option>
        <option value="normal">Normal</option>
    </select>
</div>
            
            <div class="form-group">
                <label for="globo-imagen">URL de la Imagen</label>
                <input type="url" class="form-control" id="globo-imagen">
            </div>
            
            <div class="modal-actions">
                <button type="button" id="cancel-globo-btn" class="btn btn-secondary">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Globo</button>
            </div>
        </form>
    </div>
</div>

        </div>
    </div>

<!-- Modal para D칤as Clausurados -->
<div id="dia-clausurado-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="dia-clausurado-modal-title">Agregar D칤a Clausurado</h3>
            <button type="button" id="cancel-dia-clausurado-btn" class="close-btn">&times;</button>
        </div>
        <form id="dia-clausurado-form">
            <input type="hidden" id="dia-clausurado-firebase-key">
            
            <div class="form-group">
                <label for="dia-clausurado-fecha">Fecha</label>
<input type="text" class="form-control" id="dia-clausurado-fecha" required readonly placeholder="Selecciona una fecha">            </div>
            
            <div class="form-group">
                <label for="dia-clausurado-motivo">Motivo del Cierre</label>
                <input type="text" class="form-control" id="dia-clausurado-motivo" placeholder="Ej: Navidad, Mantenimiento, D칤a festivo" required>
            </div>
            
            <div class="modal-actions">
                <button type="button" id="cancel-dia-clausurado-btn-2" class="btn btn-secondary">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar D칤a Clausurado</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para Lazos -->
<div id="lazo-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="lazo-modal-title">Agregar Lazo</h3>
            <button type="button" id="cancel-lazo-btn" class="close-btn">&times;</button>
        </div>
        <form id="lazo-form">
            <input type="hidden" id="lazo-firebase-key">
            
            <div class="form-group">
                <label for="lazo-nombre">Nombre del Lazo</label>
                <input type="text" class="form-control" id="lazo-nombre" required placeholder="Ej: PLATEADO">
            </div>
            
            <div class="form-group">
                <label for="lazo-codigo">C칩digo de Color</label>
                <input type="text" class="form-control" id="lazo-codigo" required placeholder="Ej: #d9dadf">
                <small class="form-text text-muted">Formato hexadecimal: #ffffff</small>
            </div>
            
            <div class="form-group">
                <label>Vista previa del color:</label>
                <div id="lazo-color-preview" style="width: 50px; height: 50px; border: 2px solid #ccc; border-radius: 4px; background: #ffffff;"></div>
            </div>
            
            <div class="modal-actions">
                <button type="button" id="cancel-lazo-btn-2" class="btn btn-secondary">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Lazo</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para Sorprende -->
<div id="sorprende-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="sorprende-modal-title">Agregar Imagen Sorprende</h3>
            <button type="button" id="cancel-sorprende-btn" class="close-btn">&times;</button>
        </div>
        <form id="sorprende-form">
            <input type="hidden" id="sorprende-firebase-key">
            
            <div class="form-group">
                <label for="sorprende-url">URL de la Imagen</label>
                <input type="url" class="form-control" id="sorprende-url" required>
            </div>
            
            <div class="form-group">
                <label for="sorprende-alt">Texto Alternativo</label>
                <input type="text" class="form-control" id="sorprende-alt" required placeholder="Ej: Cliente satisfecho 1">
            </div>
            
            <div class="form-group">
                <label for="sorprende-orden">Orden de Aparici칩n</label>
                <input type="number" class="form-control" id="sorprende-orden" required min="1" placeholder="1, 2, 3...">
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="sorprende-activo" checked> Imagen Activa
                </label>
                <small class="form-text text-muted">Solo las im치genes activas se mostrar치n en el sitio</small>
            </div>
            
            <div class="modal-actions">
                <button type="button" id="cancel-sorprende-btn-2" class="btn btn-secondary">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Imagen</button>
            </div>
        </form>
    </div>
</div>


<div class="modal" id="product-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background-color: #dddfe0; padding: 30px; border-radius: 10px; width: 80%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
        <h2 style="margin-bottom: 20px;" id="modal-title">Agregar Producto</h2>
        <form id="product-form">
            <input type="hidden" id="product-firebase-key">
            
            <div class="form-group">
                <label for="product-id">ID del Producto*</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" class="form-control" id="product-id" required style="flex: 1;">
                    <button type="button" class="btn btn-secondary" id="generate-id-btn">
                    </button>
                </div>
                <small class="form-text text-muted">Usa un n칰mero o ID como -OX_bS76PWUEdA0fXP3B</small>
            </div>
            
            <div class="form-group">
                <label for="product-name">Nombre del Producto*</label>
                <input type="text" class="form-control" id="product-name" required>
            </div>
            
            <div class="form-group">
                <label for="product-category">Categor칤a*</label>
                <select class="form-control" id="product-category" required>
                    <option value="">Selecciona una categor칤a</option>
                    <option value="arreglos">Arreglos</option>
                    <option value="box">Box</option>
                    <option value="fresas">Fresas</option>
                    <option value="frutales">Frutales</option>
                    <option value="desayunos">Desayunos</option>
                    <option value="diaespecial">Catalogo Especial</option>
                    <option value="promociones">Promociones</option>
                    
                </select>
            </div>
            
            <div class="form-group">
                <label for="product-price">Precio*</label>
                <input type="number" class="form-control" id="product-price" required>
            </div>
            
            <div class="form-group">
                <label for="product-description">Descripci칩n*</label>
                <textarea class="form-control" id="product-description" required></textarea>
            </div>
            
            <div class="form-group">
                <label for="product-image1">Imagen Principal (URL)*</label>
                <input type="text" class="form-control" id="product-image1" required>
            </div>
            
            <div class="form-group">
                <label for="product-image2">Imagen 2 (URL)</label>
                <input type="text" class="form-control" id="product-image2">
            </div>
            
            <div class="form-group">
                <label for="product-image3">Imagen 3 (URL)</label>
                <input type="text" class="form-control" id="product-image3">
            </div>
            
            <div class="form-group">
                <label>
                </label>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-danger" id="cancel-product-btn">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Producto</button>
            </div>
        </form>
    </div>
</div>


    <!-- Modal para editar imagen del carrusel -->
<div class="carousel-modal" id="carousel-image-modal">
    <div class="carousel-modal-content">
        <h2>Editar Imagen del Carrusel</h2>
        <form id="edit-carousel-image-form">
            <input type="hidden" id="edit-carousel-type">
            <input type="hidden" id="edit-carousel-index">
            
            <div class="form-group">
                <label for="edit-carousel-url">URL de la imagen</label>
                <input type="text" class="form-control" id="edit-carousel-url" required>
            </div>
            
            <div class="form-group">
                <label for="edit-carousel-alt">Texto alternativo (alt)</label>
                <input type="text" class="form-control" id="edit-carousel-alt">
            </div>
            
             <div class="form-group">
                <label for="edit-carousel-link">Enlace (link)</label>
                <select class="form-control" id="edit-carousel-link">
                     <option value="">(Sin enlace)</option>
                    <option value="desayunos.html">desayunos</option>
                    <option value="fresas.html">fresas</option>
                    <option value="box.html">box y licores</option>
                    <option value="arreglos.html">arreglos florales</option>
                    <option value="frutales.html">frutales</option>
                    <option value="promociones.html">promociones</option>
                </select>
            </div>
            
            <div class="carousel-modal-buttons">
                <button type="button" class="btn btn-danger" id="cancel-edit-carousel">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>


<div id="modalYtxd" class="modal-ytxd">
  <span class="close-ytxd">&times;</span>
  <img class="modal-content-ytxd" id="modalImgYtxd">
</div>

<!-- Modal para confirmar eliminaci칩n -->
<div class="carousel-modal" id="delete-confirmation-modal">
    <div class="carousel-modal-content">
        <h2>Confirmar Eliminaci칩n</h2>
        <p>쮼st치s seguro de que deseas eliminar esta imagen?</p>
        <div class="carousel-modal-buttons">
            <button type="button" class="btn btn-secondary" id="cancel-delete">Cancelar</button>
            <button type="button" class="btn btn-danger" id="confirm-delete">Eliminar</button>
        </div>
    </div>
</div>

<!-- Modal para agregar nueva imagen -->
<!-- Modal para agregar nueva imagen (versi칩n actualizada) -->
<div class="carousel-modal" id="add-image-modal">
    <div class="carousel-modal-content">
        <h2>Agregar Nueva Imagen</h2>
        <form id="add-carousel-image-form">
            <input type="hidden" id="add-carousel-type">
            
            <div class="form-group">
                <label for="new-carousel-url">URL de la imagen*</label>
                <input type="text" class="form-control" id="new-carousel-url" required>
            </div>
            
            <div class="form-group">
                <label for="new-carousel-alt">Texto alternativo (alt)</label>
                <input type="text" class="form-control" id="new-carousel-alt" placeholder="Ej: Arreglo de fresas con chocolate">
            </div>
            
            <div class="form-group">
                <label for="new-carousel-link">Enlace de destino</label>
                <select class="form-control" id="new-carousel-link">
                    <option value="">(Sin enlace)</option>
                    <option value="desayunos.html">desayunos</option>
                    <option value="fresas.html">fresas</option>
                    <option value="box.html">box y licores</option>
                    <option value="arreglos.html">arreglos florales</option>
                    <option value="frutales.html">frutales</option>
                    <option value="promociones.html">promociones</option>
                    <!-- Agrega m치s opciones seg칰n necesites -->
                </select>
            </div>
            
            <div class="carousel-modal-buttons">
                <button type="button" class="btn btn-danger" id="cancel-add-carousel">Cancelar</button>
                <button type="submit" class="btn btn-primary">Agregar Imagen</button>
            </div>
        </form>
    </div>
</div>


    <!-- Order Detail Modal -->
    <div class="modal" id="order-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background-color: white; padding: 30px; border-radius: 10px; width: 80%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-bottom: 20px;">Detalle del Pedido <span id="order-id"></span></h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <h3 style="margin-bottom: 10px;">Informaci칩n del Cliente</h3>
                    <p><strong>Nombre:</strong> <span id="client-name"></span></p>
                    <p><strong>Email:</strong> <span id="client-email"></span></p>
                    <p><strong>Tel칠fono:</strong> <span id="client-phone"></span></p>
                    <p><strong>Direcci칩n:</strong> <span id="client-address"></span></p>
                </div>
                
                <div>
                    <h3 style="margin-bottom: 10px;">Informaci칩n del Pedido</h3>
                    <p><strong>Fecha:</strong> <span id="order-date"></span></p>
                    <p><strong>Estado:</strong> <span id="order-status"></span></p>
                    <p><strong>M칠todo de Pago:</strong> <span id="order-payment"></span></p>
                    <p><strong>Subtotal:</strong> <span id="order-subtotal"></span></p>
                    <p><strong>Env칤o:</strong> <span id="order-shipping"></span></p>
                    <p><strong>Total:</strong> <span id="order-total"></span></p>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">Adicionales</h3>
                <p><strong>Motivo:</strong> <span id="order-reason"></span></p>
                <p><strong>Globos:</strong> <span id="order-balloons"></span></p>
                <p><strong>Color Globo:</strong> <span id="order-balloon-color"></span></p>
                <p><strong>Mensaje:</strong> <span id="order-message"></span></p>
                <p><strong>Costo Adicional:</strong> <span id="order-additional-cost"></span></p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">Productos</h3>
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="order-products">
                        <!-- Productos se llenar치n con JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <label for="status-select">Cambiar Estado:</label>
                    <select id="status-select" style="margin-left: 10px; padding: 5px;">
                        <option value="Por realizar" class="option-por-realizar">Por realizar</option>
    <option value="Pago" class="option-pago">Pago</option>
    <option value="Entregado" class="option-entregado">Entregado</option>
    <option value="Aplazado" class="option-aplazado">Aplazado</option>
                    </select>
                    <button type="button" class="btn btn-primary" style="margin-left: 10px;" id="update-status-btn">Actualizar</button>
                </div>
                <button type="button" class="btn btn-danger" id="close-order-modal">Cerrar</button>
            </div>
        </div>
    </div>

     <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="js/fivernimda.js"></script>


   <script>
    const firebaseConfig = {
  apiKey: "AIzaSyBoRNOrpueYTJVeqxZwMtUsyAYArEHvgVU",
  authDomain: "morenita0ficial.firebaseapp.com",
  databaseURL: "https://morenita0ficial-default-rtdb.firebaseio.com",
  projectId: "morenita0ficial",
  storageBucket: "morenita0ficial.firebasestorage.app",
  messagingSenderId: "867231481408",
  appId: "1:867231481408:web:50512d7709d3b9d4e7a9a5"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let currentOrderId = null, salesChart = null, ordersChart = null, isFormSubmitting = false;
let currentProductCategory = 'all';

document.addEventListener('DOMContentLoaded', function() {
    setupNavigation();
    setupProductTabs(); // AGREGAR ESTA L칈NEA
    loadDashboardData();
    loadProducts();
    loadConfiguration();
    setupFormEvents();
    setupCarouselTabs();
    setupCarouselAddButtons();
    setupCarouselModal();
    loadCarouselImages();
    setupSpecialCatalogControl();
    loadOverlayConfig();
    setupAdicionesGlobosEvents();
    loadAdiciones();
    loadGlobos();
    setupDiasClausuradosEvents();
    loadDiasClausurados();
    
    // Agregar event listener para el bot칩n de generar ID
    document.getElementById('generate-id-btn')?.addEventListener('click', function() {
        document.getElementById('product-id').value = generateProductId();
    });
});
function updateOrderStatus() {
    if (!currentOrderId) {
        alert('No hay pedido seleccionado');
        return;
    }
    
    const statusSelect = document.getElementById('status-select');
    if (!statusSelect) {
        alert('Selector de estado no encontrado');
        return;
    }
    
    const newStatus = statusSelect.value;
    
    if (!newStatus) {
        alert('Selecciona un estado v치lido');
        return;
    }
     const validStatuses = ['Por realizar', 'Pago', 'Entregado', 'Aplazado'];
    if (!validStatuses.includes(newStatus)) {
        alert('Selecciona un estado v치lido');
        return;
    }
    
    // Actualizar el estado en Firebase
    db.ref(`pedidos/${currentOrderId}`).update({
        estado: newStatus
    }).then(() => {
        alert(`Estado actualizado a: ${newStatus}`);
        // Recargar datos del dashboard
        loadDashboardData();
        // Cerrar el modal
        const modal = document.getElementById('order-modal');
        if (modal) modal.style.display = 'none';
    }).catch(error => {
        console.error('Error al actualizar estado:', error);
        alert('Error al actualizar el estado: ' + error.message);
    });
}


// Cargar todos los lazos
function loadLazos() {
    db.ref('colores-lazos').once('value').then(snapshot => {
        const lazosData = snapshot.val();
        if (lazosData) displayLazos(lazosData);
    }).catch(error => console.error("Error al cargar lazos:", error));
}

// Mostrar lazos en la grid
function displayLazos(lazosData) {
    const lazosGrid = document.getElementById('lazos-grid');
    if (!lazosGrid) return;
    
    lazosGrid.innerHTML = '';
    
    Object.keys(lazosData).forEach(key => {
        const lazo = lazosData[key];
        if (!lazo) return;
        
        const lazoCard = document.createElement('div');
        lazoCard.className = 'product-card';
        lazoCard.innerHTML = `
            <div class="product-image" style="background: ${lazo.codigo || '#ffffff'}; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; color: ${getContrastColor(lazo.codigo)}; font-weight: bold;">
                <i class="fas fa-ribbon" style="font-size: 32px;"></i>
            </div>
            <div class="product-info">
                <div class="product-name">${lazo.nombre || 'Sin nombre'}</div>
                <div class="product-price">${lazo.codigo || 'Sin c칩digo'}</div>
                <div class="product-category-badge">Lazo</div>
                <div class="product-actions">
                    <button class="btn btn-primary btn-sm edit-lazo-btn" data-key="${key}">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm delete-lazo-btn" data-key="${key}">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        `;
        lazosGrid.appendChild(lazoCard);
    });
    
    if (Object.keys(lazosData).length === 0) {
        lazosGrid.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No hay lazos configurados</p>';
    }
}

// Funci칩n para obtener color de contraste
function getContrastColor(hexcolor) {
    if (!hexcolor) return '#000000';
    hexcolor = hexcolor.replace('#', '');
    const r = parseInt(hexcolor.substr(0,2),16);
    const g = parseInt(hexcolor.substr(2,2),16);
    const b = parseInt(hexcolor.substr(4,2),16);
    const brightness = ((r * 299) + (g * 587) + (b * 114)) / 1000;
    return brightness > 155 ? '#000000' : '#ffffff';
}

// Mostrar modal para agregar/editar lazo
function showLazoModal(lazo = null) {
    const modal = document.getElementById('lazo-modal');
    const form = document.getElementById('lazo-form');
    const modalTitle = document.getElementById('lazo-modal-title');
    const firebaseKeyField = document.getElementById('lazo-firebase-key');
    
    form.reset();
    
    if (lazo) {
        modalTitle.textContent = 'Editar Lazo';
        firebaseKeyField.value = lazo.firebaseKey || '';
        document.getElementById('lazo-nombre').value = lazo.nombre || '';
        document.getElementById('lazo-codigo').value = lazo.codigo || '';
        updateColorPreview(lazo.codigo || '#ffffff');
    } else {
        modalTitle.textContent = 'Agregar Lazo';
        firebaseKeyField.value = '';
        updateColorPreview('#ffffff');
    }
    
    modal.style.display = 'flex';
}

// Actualizar vista previa del color
function updateColorPreview(color) {
    const preview = document.getElementById('lazo-color-preview');
    if (preview) {
        preview.style.backgroundColor = color;
    }
}

// Guardar lazo
function saveLazo(lazoData, isEditMode) {
    if (isEditMode) {
        return db.ref(`colores-lazos/${lazoData.firebaseKey}`).update(lazoData);
    } else {
        const newRef = db.ref('colores-lazos').push();
        return newRef.set(lazoData);
    }
}

// Handler para guardar lazo
function saveLazoHandler() {
    if (isFormSubmitting) return;
    
    const modal = document.getElementById('lazo-modal');
    const firebaseKey = document.getElementById('lazo-firebase-key').value;
    const isEditMode = !!firebaseKey;
    
    const lazoData = {
        nombre: document.getElementById('lazo-nombre').value.trim().toUpperCase(),
        codigo: document.getElementById('lazo-codigo').value.trim(),
        firebaseKey: firebaseKey || null
    };

    // Validar formato de color hexadecimal
    const hexPattern = /^#[0-9A-Fa-f]{6}$/;
    if (!lazoData.nombre || !lazoData.codigo || !hexPattern.test(lazoData.codigo)) {
        alert('Por favor complete todos los campos. El c칩digo de color debe tener formato #ffffff');
        return;
    }

    isFormSubmitting = true;
    const submitBtn = document.querySelector('#lazo-form [type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

    saveLazo(lazoData, isEditMode)
        .then(() => {
            alert(isEditMode ? 'Lazo actualizado correctamente' : 'Lazo agregado correctamente');
            modal.style.display = 'none';
            loadLazos();
        })
        .catch(error => {
            console.error("Error al guardar lazo:", error);
            alert('Error: ' + error.message);
        })
        .finally(() => {
            isFormSubmitting = false;
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        });
}

// ===== FUNCIONES PARA SORPRENDE =====

// Cargar todas las im치genes de sorprende
function loadSorprende() {
    db.ref('sorprende-imgs').once('value').then(snapshot => {
        const sorprendeData = snapshot.val();
        if (sorprendeData) displaySorprende(sorprendeData);
    }).catch(error => console.error("Error al cargar im치genes sorprende:", error));
}

// Mostrar im치genes sorprende en la grid
function displaySorprende(sorprendeData) {
    const sorprendeGrid = document.getElementById('sorprende-grid');
    if (!sorprendeGrid) return;
    
    sorprendeGrid.innerHTML = '';
    
    Object.keys(sorprendeData).forEach(key => {
        const imagen = sorprendeData[key];
        if (!imagen) return;
        
        const imagenCard = document.createElement('div');
        imagenCard.className = 'product-card';
        imagenCard.innerHTML = `
            <div class="product-image" style="background-image: url('${imagen.url || ''}')"></div>
            <div class="product-info">
                <div class="product-name">${imagen.alt || 'Sin descripci칩n'}</div>
                <div class="product-description">Orden: ${imagen.orden || 'Sin orden'}</div>
                <div class="product-price">${imagen.activo ? 'ACTIVA' : 'INACTIVA'}</div>
                <div class="product-category-badge ${imagen.activo ? 'active' : 'inactive'}">${imagen.activo ? 'Visible' : 'Oculta'}</div>
                <div class="product-actions">
                    <button class="btn btn-primary btn-sm edit-sorprende-btn" data-key="${key}">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm delete-sorprende-btn" data-key="${key}">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        `;
        sorprendeGrid.appendChild(imagenCard);
    });
    
    if (Object.keys(sorprendeData).length === 0) {
        sorprendeGrid.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No hay im치genes configuradas</p>';
    }
}

// Mostrar modal para agregar/editar imagen sorprende
function showSorprendeModal(imagen = null) {
    const modal = document.getElementById('sorprende-modal');
    const form = document.getElementById('sorprende-form');
    const modalTitle = document.getElementById('sorprende-modal-title');
    const firebaseKeyField = document.getElementById('sorprende-firebase-key');
    
    form.reset();
    
    if (imagen) {
        modalTitle.textContent = 'Editar Imagen Sorprende';
        firebaseKeyField.value = imagen.firebaseKey || '';
        document.getElementById('sorprende-url').value = imagen.url || '';
        document.getElementById('sorprende-alt').value = imagen.alt || '';
        document.getElementById('sorprende-orden').value = imagen.orden || 1;
        document.getElementById('sorprende-activo').checked = imagen.activo !== false;
    } else {
        modalTitle.textContent = 'Agregar Imagen Sorprende';
        firebaseKeyField.value = '';
        document.getElementById('sorprende-activo').checked = true;
    }
    
    modal.style.display = 'flex';
}

// Guardar imagen sorprende
function saveSorprende(sorprendeData, isEditMode) {
    if (isEditMode) {
        return db.ref(`sorprende-imgs/${sorprendeData.firebaseKey}`).update(sorprendeData);
    } else {
        const newRef = db.ref('sorprende-imgs').push();
        return newRef.set(sorprendeData);
    }
}

// Handler para guardar imagen sorprende
function saveSorprendeHandler() {
    if (isFormSubmitting) return;
    
    const modal = document.getElementById('sorprende-modal');
    const firebaseKey = document.getElementById('sorprende-firebase-key').value;
    const isEditMode = !!firebaseKey;
    
    const sorprendeData = {
        url: document.getElementById('sorprende-url').value.trim(),
        alt: document.getElementById('sorprende-alt').value.trim(),
        orden: parseInt(document.getElementById('sorprende-orden').value),
        activo: document.getElementById('sorprende-activo').checked,
        firebaseKey: firebaseKey || null
    };

    if (!sorprendeData.url || !sorprendeData.alt || isNaN(sorprendeData.orden)) {
        alert('Por favor complete todos los campos requeridos');
        return;
    }

    isFormSubmitting = true;
    const submitBtn = document.querySelector('#sorprende-form [type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

    saveSorprende(sorprendeData, isEditMode)
        .then(() => {
            alert(isEditMode ? 'Imagen actualizada correctamente' : 'Imagen agregada correctamente');
            modal.style.display = 'none';
            loadSorprende();
        })
        .catch(error => {
            console.error("Error al guardar imagen:", error);
            alert('Error: ' + error.message);
        })
        .finally(() => {
            isFormSubmitting = false;
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        });
}

// Editar elementos
function editLazo(firebaseKey) {
    db.ref(`colores-lazos/${firebaseKey}`).once('value').then(snapshot => {
        const lazo = snapshot.val();
        if (lazo) {
            lazo.firebaseKey = firebaseKey;
            showLazoModal(lazo);
        }
    });
}

function editSorprende(firebaseKey) {
    db.ref(`sorprende-imgs/${firebaseKey}`).once('value').then(snapshot => {
        const imagen = snapshot.val();
        if (imagen) {
            imagen.firebaseKey = firebaseKey;
            showSorprendeModal(imagen);
        }
    });
}

// Eliminar elementos
function deleteLazo(firebaseKey) {
    db.ref(`colores-lazos/${firebaseKey}`).remove()
        .then(() => {
            alert('Lazo eliminado correctamente');
            loadLazos();
        })
        .catch(error => alert('Error al eliminar: ' + error.message));
}

function deleteSorprende(firebaseKey) {
    db.ref(`sorprende-imgs/${firebaseKey}`).remove()
        .then(() => {
            alert('Imagen eliminada correctamente');
            loadSorprende();
        })
        .catch(error => alert('Error al eliminar: ' + error.message));
}

// ===== CONFIGURACI칍N DE EVENTOS =====

function setupLazosSorprendeEvents() {
    // Event delegation para lazos
    const lazosGrid = document.getElementById('lazos-grid');
    if (lazosGrid) {
        lazosGrid.addEventListener('click', function(e) {
            const editBtn = e.target.closest('.edit-lazo-btn');
            const deleteBtn = e.target.closest('.delete-lazo-btn');
            
            if (editBtn) {
                editLazo(editBtn.getAttribute('data-key'));
            }
            if (deleteBtn && confirm('쮼st치s seguro de que deseas eliminar este lazo?')) {
                deleteLazo(deleteBtn.getAttribute('data-key'));
            }
        });
    }

    // Event delegation para sorprende
    const sorprendeGrid = document.getElementById('sorprende-grid');
    if (sorprendeGrid) {
        sorprendeGrid.addEventListener('click', function(e) {
            const editBtn = e.target.closest('.edit-sorprende-btn');
            const deleteBtn = e.target.closest('.delete-sorprende-btn');
            
            if (editBtn) {
                editSorprende(editBtn.getAttribute('data-key'));
            }
            if (deleteBtn && confirm('쮼st치s seguro de que deseas eliminar esta imagen?')) {
                deleteSorprende(deleteBtn.getAttribute('data-key'));
            }
        });
    }

    // Botones para agregar
    document.getElementById('add-lazo-btn')?.addEventListener('click', () => showLazoModal());
    document.getElementById('add-sorprende-btn')?.addEventListener('click', () => showSorprendeModal());

    // Preview de color en tiempo real
    document.getElementById('lazo-codigo')?.addEventListener('input', function(e) {
        const color = e.target.value;
        if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
            updateColorPreview(color);
        }
    });

    // Botones para cancelar modales
    ['cancel-lazo-btn', 'cancel-lazo-btn-2'].forEach(id => {
        document.getElementById(id)?.addEventListener('click', () => {
            document.getElementById('lazo-modal').style.display = 'none';
        });
    });
    
    ['cancel-sorprende-btn', 'cancel-sorprende-btn-2'].forEach(id => {
        document.getElementById(id)?.addEventListener('click', () => {
            document.getElementById('sorprende-modal').style.display = 'none';
        });
    });

    // Formularios
    document.getElementById('lazo-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        saveLazoHandler();
    });

    document.getElementById('sorprende-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        saveSorprendeHandler();
    });
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
        item.addEventListener('click', function() {
            const tab = this.getAttribute('data-tab');
            
        });
    });
    
    document.querySelectorAll('.nav-item[data-href]').forEach(item => {
        item.addEventListener('click', function() {
            const href = this.getAttribute('data-href');
            window.location.href = href;
        });
    });
    setupLazosSorprendeEvents();
loadLazos();
loadSorprende();
});


function setupNavigation() {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function() {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            const tabId = this.getAttribute('data-tab');
            const tabElement = document.getElementById(tabId);
            
            if (tabElement) {
                tabElement.classList.add('active');
                document.getElementById('page-title').textContent = this.textContent.trim();
                
                if (tabId === 'adiciones-content') {
                    loadAdiciones();
                } else if (tabId === 'globos-content') {
                    loadGlobos();
                } else if (tabId === 'dias-clausurados') {
                    loadDiasClausurados();
                } else if (tabId === 'top-buyers') {
                    loadTopBuyers();
                } else if (tabId === 'lazos-content') {
                    loadLazos();
                } else if (tabId === 'sorprende-content') {
                    loadSorprende();
                }
            } else {
                console.error(`Elemento con ID "${tabId}" no encontrado`);
            }
        });
    });

    document.querySelectorAll('[data-order-tab]').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('[data-order-tab]').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            filterOrders(this.getAttribute('data-order-tab'));
        });
    });

    document.querySelectorAll('[data-product-tab]').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('[data-product-tab]').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            filterProducts(this.getAttribute('data-product-tab'));
        });
    });

    // Event delegation para productos
    const productsGrid = document.getElementById('products-grid');
    if (productsGrid) {
        productsGrid.addEventListener('click', function(e) {
            const editBtn = e.target.closest('.edit-product-btn');
            const deleteBtn = e.target.closest('.delete-product-btn');
            
            if (editBtn) {
                editProduct(editBtn.getAttribute('data-key'), editBtn.getAttribute('data-category'));
            }
            if (deleteBtn && confirm('쮼st치s seguro de que deseas eliminar este producto?')) {
                deleteProduct(deleteBtn.getAttribute('data-key'), deleteBtn.getAttribute('data-category'));
            }
        });
    }

    // Botones modales - con verificaci칩n de existencia
    const addProductBtn = document.getElementById('add-product-btn');
    if (addProductBtn) {
        addProductBtn.addEventListener('click', () => showProductModal());
    }

    const cancelProductBtn = document.getElementById('cancel-product-btn');
    if (cancelProductBtn) {
        cancelProductBtn.addEventListener('click', () => {
            const modal = document.getElementById('product-modal');
            if (modal) modal.style.display = 'none';
        });
    }

    const closeOrderModalBtn = document.getElementById('close-order-modal');
    if (closeOrderModalBtn) {
        closeOrderModalBtn.addEventListener('click', () => {
            const modal = document.getElementById('order-modal');
            if (modal) modal.style.display = 'none';
        });
    }

    // 九 SOLUCI칍N: Verificar si existe antes de agregar el listener
    const updateStatusBtn = document.getElementById('update-status-btn');
    if (updateStatusBtn) {
        updateStatusBtn.addEventListener('click', updateOrderStatus);
    } else {
        console.warn('Elemento update-status-btn no encontrado - se agregar치 din치micamente');
    }
}

function loadDashboardData() {
    db.ref('pedidos').once('value').then(snapshot => {
        const orders = snapshot.val() ? Object.values(snapshot.val()) : [];
        updateStats(orders);
        showRecentOrders(orders);
        createCharts(orders);
    });

    db.ref('admins/admin1').once('value').then(snapshot => {
        const admin = snapshot.val();
        if (admin) document.getElementById('admin-name').textContent = admin.nombre;
    });
}

function initializeCarouselTabs() {

    const desktopTab = document.querySelector('[data-carousel-tab="desktop"]');
    const desktopContent = document.getElementById('carousel-desktop-content');
    
    if (desktopTab && desktopContent) {
        document.querySelectorAll('[data-carousel-tab]').forEach(t => t.classList.remove('active'));
        document.getElementById('carousel-desktop-content')?.classList.remove('active');
        document.getElementById('carousel-mobile-content')?.classList.remove('active');
        
        desktopTab.classList.add('active');
        desktopContent.classList.add('active');
    }
}

// ===== FUNCIONES PARA COMPRADORES TOP =====

function loadTopBuyers() {
    db.ref('pedidos').once('value').then(snapshot => {
        const orders = snapshot.val();
        if (orders) {
            const buyersData = analyzeTopBuyers(orders);
            displayTopBuyer(buyersData[0]);
            displayAllBuyers(buyersData);
        }
    }).catch(error => {
        console.error("Error al cargar compradores:", error);
    });
}

function analyzeTopBuyers(orders) {
    const buyersMap = new Map();
    
    Object.values(orders).forEach(order => {
        
        if (order.estado === 'Aplazado') return;
        
        const userEmail = order.cliente?.email;
        const userName = order.cliente?.nombre || 'Sin nombre';
        const userPhone = order.cliente?.telefono || '';
        
        if (!userEmail) return;
        
        if (!buyersMap.has(userEmail)) {
            buyersMap.set(userEmail, {
                email: userEmail,
                displayName: userName,
                phone: userPhone,
                totalOrders: 0,
                totalProducts: 0,
                totalSpent: 0,
                products: []
            });
        }
        
        const buyer = buyersMap.get(userEmail);
        buyer.totalOrders++;
        buyer.totalSpent += order.total || 0;
        
        if (order.productos && Array.isArray(order.productos)) {
            order.productos.forEach(product => {
                buyer.totalProducts += product.cantidad || 0;
                buyer.products.push({
                    nombre: product.nombre,
                    cantidad: product.cantidad,
                    precio: product.precio,
                    categoria: product.categoria
                });
            });
        }
    });
    
    return Array.from(buyersMap.values())
        .sort((a, b) => b.totalProducts - a.totalProducts);
}

function displayTopBuyer(topBuyer) {
    const container = document.getElementById('top-buyer-highlight');
    if (!topBuyer) {
        container.innerHTML = '<p style="color: #9CA3AF;">No hay compradores disponibles</p>';
        return;
    }
    
    const initial = topBuyer.displayName.charAt(0).toUpperCase();
    
    container.innerHTML = `
        <div class="top-buyer-avatar-large">${initial}</div>
        <div class="top-buyer-name">${topBuyer.displayName}</div>
        <div class="top-buyer-stats">
            <div class="top-buyer-stat">
                <span class="value">${topBuyer.totalProducts}</span>
                <span class="label">Productos Comprados</span>
            </div>
            <div class="top-buyer-stat">
                <span class="value">${topBuyer.totalOrders}</span>
                <span class="label">Pedidos</span>
            </div>
            <div class="top-buyer-stat">
                <span class="value">$${topBuyer.totalSpent.toLocaleString()}</span>
                <span class="label">Total Gastado</span>
            </div>
        </div>
        ${topBuyer.phone ? `
            <button class="whatsapp-btn" onclick="contactBuyer('${topBuyer.phone}', '${topBuyer.displayName}')">
                <i class="fas fa-whatsapp"></i> Contactar por WhatsApp
            </button>
        ` : ''}
    `;
}

function displayAllBuyers(buyersData) {
    const container = document.getElementById('all-buyers-list');
    container.innerHTML = '';
    
    buyersData.forEach((buyer, index) => {
        const rank = index + 1;
        const initial = buyer.displayName.charAt(0).toUpperCase();
        
        const buyerItem = document.createElement('div');
        buyerItem.className = 'buyer-item';
        buyerItem.innerHTML = `
            <div class="buyer-rank-small">${rank}</div>
            <div class="buyer-item-header">
                <div class="buyer-avatar-small">${initial}</div>
                <div class="buyer-basic-info">
                    <h4>${buyer.displayName}</h4>
                    <div class="email">${buyer.email}</div>
                </div>
            </div>
            <div class="buyer-quick-stats">
                <div class="quick-stat">
                    <span class="value">${buyer.totalProducts}</span>
                    <span class="label">Productos</span>
                </div>
                <div class="quick-stat">
                    <span class="value">${buyer.totalOrders}</span>
                    <span class="label">Pedidos</span>
                </div>
            </div>
            <div class="buyer-actions">
                <button class="details-btn" onclick="showBuyerDetails(${index})">Ver Detalles</button>
                ${buyer.phone ? `
                    <button class="whatsapp-btn" onclick="contactBuyer('${buyer.phone}', '${buyer.displayName}')">
                       Contactar
                    </button>
                ` : ''}
            </div>
        `;
        container.appendChild(buyerItem);
    });
}

let currentBuyersData = [];

function showBuyerDetails(index) {
    const buyer = currentBuyersData[index];
    if (!buyer) return;
    
    const modal = document.getElementById('buyer-details-modal') || createBuyerDetailsModal();
    const content = modal.querySelector('.buyer-details-content');
    
    content.innerHTML = `
        <button class="close-details" onclick="closeBuyerDetails()">&times;</button>
        <div class="buyer-details-header">
            
            <h3 style="color: #F3F4F6; text-align: center; margin: 0 0 20px 0;">${buyer.displayName}</h3>
        </div>
        <div class="buyer-summary" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div style="background: #111827; padding: 15px; border-radius: 6px; text-align: center;">
                <div style="color: #6366F1; font-size: 1.5em; font-weight: bold;">${buyer.totalProducts}</div>
                <div style="color: #9CA3AF; font-size: 0.9em;">Productos</div>
            </div>
            <div style="background: #111827; padding: 15px; border-radius: 6px; text-align: center;">
                <div style="color: #6366F1; font-size: 1.5em; font-weight: bold;">${buyer.totalOrders}</div>
                <div style="color: #9CA3AF; font-size: 0.9em;">Pedidos</div>
            </div>
            <div style="background: #111827; padding: 15px; border-radius: 6px; text-align: center;">
                <div style="color: #6366F1; font-size: 1.5em; font-weight: bold;">$${buyer.totalSpent.toLocaleString()}</div>
                <div style="color: #9CA3AF; font-size: 0.9em;">Gastado</div>
            </div>
        </div>
        <div class="products-list">
            <h4 style="color: #F3F4F6; margin-bottom: 15px;">Productos Comprados</h4>
            ${buyer.products.map(product => `
                <div class="product-item">
                    <div class="product-info">
                        <div style="font-weight: bold;">${product.nombre}</div>
                        <div style="color: #9CA3AF; font-size: 0.9em;">$${product.precio?.toLocaleString()} - ${product.categoria}</div>
                    </div>
                    <div class="product-quantity">칑${product.cantidad}</div>
                </div>
            `).join('')}
        </div>
    `;
    
    modal.style.display = 'flex';
}

function createBuyerDetailsModal() {
    const modal = document.createElement('div');
    modal.id = 'buyer-details-modal';
    modal.className = 'buyer-details-modal';
    modal.innerHTML = '<div class="buyer-details-content"></div>';
    document.body.appendChild(modal);
    return modal;
}

function closeBuyerDetails() {
    const modal = document.getElementById('buyer-details-modal');
    if (modal) modal.style.display = 'none';
}

function contactBuyer(phone, name) {
    const cleanPhone = phone.replace(/\D/g, '');
    const message = encodeURIComponent(`Hola ${name}, te contactamos desde La Morenita para agradecerte por ser uno de nuestros mejores clientes!`);
    const whatsappUrl = `https://wa.me/57${cleanPhone}?text=${message}`;
    window.open(whatsappUrl, '_blank');
}

// Actualizar la funci칩n loadTopBuyers para guardar los datos
function loadTopBuyers() {
    db.ref('pedidos').once('value').then(snapshot => {
        const orders = snapshot.val();
        if (orders) {
            currentBuyersData = analyzeTopBuyers(orders);
            displayTopBuyer(currentBuyersData[0]);
            displayAllBuyers(currentBuyersData);
        }
    }).catch(error => {
        console.error("Error al cargar compradores:", error);
    });
}


function setupProductTabs() {
    document.querySelectorAll('[data-product-tab]').forEach(tab => {
        tab.addEventListener('click', function() {
            // Remover clase active de todos los tabs
            document.querySelectorAll('[data-product-tab]').forEach(t => t.classList.remove('active'));
            
            // Agregar clase active al tab clickeado
            this.classList.add('active');
            
            // Obtener la categor칤a y filtrar
            const category = this.getAttribute('data-product-tab');
            filterProducts(category);
        });
    });
}

// Funci칩n para generar ID autom치tico - NUEVA
function generateProductId() {
    const timestamp = Date.now();
    const random = Math.floor(Math.random() * 1000);
    return `prod-${timestamp}-${random}`;
}

function updateStats(orders) {
    const totalOrders = orders.length;
   
    const pendingOrders = orders.filter(o => o.estado === 'Por realizar').length;
    const shippedOrders = orders.filter(o => o.estado === 'Entregado');
    const totalRevenue = shippedOrders.reduce((sum, order) => sum + order.total, 0);
    const soldProducts = shippedOrders.reduce((sum, order) => sum + order.productos.reduce((prodSum, product) => prodSum + product.cantidad, 0), 0);

    document.getElementById('total-orders').textContent = totalOrders;
    document.getElementById('pending-orders').textContent = pendingOrders;
    document.getElementById('total-revenue').textContent = `$${totalRevenue.toLocaleString()}`;
    document.getElementById('sold-products').textContent = soldProducts;
    
    ['orders-change', 'revenue-change', 'pending-change', 'products-change'].forEach((id, i) => {
        document.getElementById(id).textContent = '-';
    });
}

function showRecentOrders(orders) {
    const tbody = document.querySelector('#recent-orders tbody');
    tbody.innerHTML = '';
    
    orders.sort((a, b) => b.timestamp - a.timestamp).slice(0, 5).forEach(order => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${order.id}</td>
            <td>${order.cliente.nombre}</td>
            <td>${order.fechaFormateada}</td>
            <td>$${order.total.toLocaleString()}</td>
            <td><span class="status ${getStatusClass(order.estado)}">${order.estado}</span></td>
        `;
        tbody.appendChild(tr);
    });
}

function createCharts(orders) {
    const salesCtx = document.getElementById('sales-chart').getContext('2d');
    
    
     const shippedOrders = orders.filter(o => o.estado === 'Entregado');
    
    const monthlySales = {};
    
    const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                       'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    
    shippedOrders.forEach(order => {
        let monthName = null;
        
        if (order.fechaFormateada) {
            // Extraer el mes de la fecha (asumiendo formato DD/MM/YYYY)
            const dateParts = order.fechaFormateada.split('/');
            if (dateParts.length >= 2) {
                const monthIndex = parseInt(dateParts[1]) - 1; // Mes (0-11)
                if (monthIndex >= 0 && monthIndex < 12) {
                    monthName = monthNames[monthIndex];
                }
            }
        } else if (order.timestamp) {
            // Si no hay fechaFormateada, usar timestamp
            const date = new Date(order.timestamp);
            monthName = monthNames[date.getMonth()];
        }
        
        // Solo agregar el mes si se pudo extraer y tiene un pedido
        if (monthName) {
            if (!monthlySales[monthName]) {
                monthlySales[monthName] = 0;
            }
            monthlySales[monthName] += order.total;
        }
    });
    
    // Ordenar los meses cronol칩gicamente (opcional)
    const sortedMonths = Object.keys(monthlySales).sort((a, b) => {
        return monthNames.indexOf(a) - monthNames.indexOf(b);
    });
    
    const sortedSales = sortedMonths.map(month => monthlySales[month]);
    
    if (salesChart) salesChart.destroy();
    
    salesChart = new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: sortedMonths.length > 0 ? sortedMonths : ['Sin datos'],
            datasets: [{
                label: 'Ventas Mensuales (Solo entregados)',
                data: sortedSales.length > 0 ? sortedSales : [0],
                backgroundColor: 'rgba(108, 92, 231, 0.2)',
                borderColor: 'rgba(108, 92, 231, 1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                tooltip: { callbacks: { label: context => ` $${context.raw.toLocaleString()}` } }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: value => `$${value.toLocaleString()}` }
                }
            }
        }
    });

    // La gr치fica de pedidos por estado se mantiene igual (cuenta TODOS los pedidos)
    const ordersCtx = document.getElementById('orders-chart').getContext('2d');
   const ordersByStatus = {
        'Por realizar': orders.filter(o => o.estado === 'Por realizar').length,
        'Pago': orders.filter(o => o.estado === 'Pago').length,
        'Entregado': orders.filter(o => o.estado === 'Entregado').length,
        'Aplazado': orders.filter(o => o.estado === 'Aplazado').length
    };

    if (ordersChart) ordersChart.destroy();

    ordersChart = new Chart(ordersCtx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(ordersByStatus),
            datasets: [{
                data: Object.values(ordersByStatus),
               backgroundColor: [
                    'rgba(255, 152, 0, 0.7)',    // Por realizar - Naranja
                    'rgba(76, 175, 80, 0.7)',    // Pago - Verde
                    'rgba(33, 150, 243, 0.7)',   // Entregado - Azul
                    'rgba(244, 67, 54, 0.7)'     // Aplazado - Rojo
                ],
                borderColor: ['rgba(253, 203, 110, 1)', 'rgba(162, 155, 254, 1)', 'rgba(0, 184, 148, 1)'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: context => {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((context.raw / total) * 100);
                            return `${context.label}: ${context.raw} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}
function loadProducts() {
    db.ref('productos').once('value').then(snapshot => {
        const productsData = snapshot.val();
        if (productsData) {
            displayProducts(productsData);
            // Mantener la categor칤a actual despu칠s de recargar
            if (currentProductCategory !== 'all') {
                filterProducts(currentProductCategory);
            }
        }
    }).catch(error => console.error("Error al cargar productos:", error));
}


function displayProducts(productsData) {
    const productsGrid = document.getElementById('products-grid');
    productsGrid.innerHTML = '';
    
    if (!productsData) {
        productsGrid.innerHTML = '<p>No hay productos disponibles.</p>';
        return;
    }
    
    Object.keys(productsData).forEach(category => {
        if (productsData[category] && typeof productsData[category] === 'object') {
            Object.keys(productsData[category]).forEach(key => {
                const product = productsData[category][key];
                if (!product) return;
                
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.setAttribute('data-category', category);
                productCard.innerHTML = `
                    <div class="product-image" style="background-image: url('${product.imagen || ''}')"></div>
                    <div class="product-info">
                        <div class="product-name">${product.nombre || 'Sin nombre'}</div>
                        <div class="product-price">$${(product.precio || 0).toLocaleString()}</div>
                        <div class="product-category-badge">${category}</div>
                        <div class="product-actions">
                            <button class="btn btn-primary btn-sm edit-product-btn" data-key="${key}" data-category="${category}">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn btn-danger btn-sm delete-product-btn" data-key="${key}" data-category="${category}">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                `;
                productsGrid.appendChild(productCard);
            });
        }
    });
}


function filterProducts(category) {
    currentProductCategory = category; // Guardar categor칤a actual
    
    db.ref('productos').once('value').then(snapshot => {
        const productsData = snapshot.val();
        const productsGrid = document.getElementById('products-grid');
        productsGrid.innerHTML = '';

        if (!productsData) {
            productsGrid.innerHTML = '<p>No hay productos disponibles.</p>';
            return;
        }

        if (category === 'all') {
            displayProducts(productsData);
            return;
        }

        if (!productsData[category]) {
            productsGrid.innerHTML = `<p>La categor칤a "${category}" no existe o est치 vac칤a.</p>`;
            return;
        }

        // Mostrar solo productos de la categor칤a seleccionada
        const categoryProducts = {};
        categoryProducts[category] = productsData[category];
        displayProducts(categoryProducts);
        
    }).catch(error => {
        console.error("Error al filtrar productos:", error);
        document.getElementById('products-grid').innerHTML = `<p>Error al cargar productos: ${error.message}</p>`;
    });
}

function showProductModal(product = null) {
    const modal = document.getElementById('product-modal');
    const form = document.getElementById('product-form');
    const modalTitle = document.getElementById('modal-title');
    const firebaseKeyField = document.getElementById('product-firebase-key');
    
    form.reset();
    
    if (product) {
        modalTitle.textContent = 'Editar Producto';
        firebaseKeyField.value = product.firebaseKey || '';
        document.getElementById('product-id').value = product.id || '';
        document.getElementById('product-name').value = product.nombre || '';
        document.getElementById('product-category').value = product.categoria || '';
        document.getElementById('product-price').value = product.precio || '';
        document.getElementById('product-description').value = product.descripcion || '';
        document.getElementById('product-image1').value = product.imagen || '';
        document.getElementById('product-image2').value = product.imagen2 || '';
        document.getElementById('product-image3').value = product.imagen3 || '';
    } else {
        modalTitle.textContent = 'Agregar Producto';
        firebaseKeyField.value = '';
        document.getElementById('product-id').value = 'prod-' + Date.now();
    }
    
    modal.style.display = 'flex';
}

function saveProduct(productData, isEditMode) {
    const category = productData.categoria;
    
    if (isEditMode) {
        // Si estamos editando, usamos la firebase key existente
        return db.ref(`productos/${category}/${productData.firebaseKey}`).update({
            id: productData.id,
            nombre: productData.nombre,
            categoria: productData.categoria,
            precio: productData.precio,
            descripcion: productData.descripcion,
            imagen: productData.imagen,
            imagen2: productData.imagen2,
            imagen3: productData.imagen3
        });
    } else {
        // Si es nuevo producto, verificamos que el ID no exista
        return new Promise((resolve, reject) => {
            // Verificar en todas las categor칤as si existe el ID
            db.ref('productos').once('value')
                .then(snapshot => {
                    const allProducts = snapshot.val() || {};
                    let idExists = false;
                    
                    // Buscar el ID en todas las categor칤as
                    Object.keys(allProducts).forEach(cat => {
                        if (allProducts[cat] && typeof allProducts[cat] === 'object') {
                            Object.keys(allProducts[cat]).forEach(key => {
                                if (allProducts[cat][key] && allProducts[cat][key].id === productData.id) {
                                    idExists = true;
                                }
                            });
                        }
                    });
                    
                    if (idExists) {
                        reject(new Error('Ya existe un producto con este ID'));
                    } else {
                        // Crear nuevo producto en la categor칤a correcta
                        const newRef = db.ref(`productos/${category}`).push();
                        const finalProductData = {
                            id: productData.id,
                            nombre: productData.nombre,
                            categoria: productData.categoria,
                            precio: productData.precio,
                            descripcion: productData.descripcion,
                            imagen: productData.imagen,
                            imagen2: productData.imagen2 || null,
                            imagen3: productData.imagen3 || null
                        };
                        newRef.set(finalProductData).then(resolve).catch(reject);
                    }
                }).catch(reject);
        });
    }
}

function saveProductHandler() {
    if (isFormSubmitting) return; 
    
    const modal = document.getElementById('product-modal');
    const firebaseKey = document.getElementById('product-firebase-key').value;
    const isEditMode = !!firebaseKey;
    
    const productData = {
        id: document.getElementById('product-id').value.trim(),
        nombre: document.getElementById('product-name').value.trim(),
        categoria: document.getElementById('product-category').value,
        precio: parseFloat(document.getElementById('product-price').value),
        descripcion: document.getElementById('product-description').value.trim(),
        imagen: document.getElementById('product-image1').value.trim(),
        imagen2: document.getElementById('product-image2').value.trim() || null,
        imagen3: document.getElementById('product-image3').value.trim() || null,
        firebaseKey: firebaseKey || null
    };

    if (!productData.id || !productData.nombre || !productData.categoria || isNaN(productData.precio)) {
        alert('Por favor complete todos los campos requeridos');
        return;
    }

    isFormSubmitting = true;
    const submitBtn = document.querySelector('#product-form [type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

    saveProduct(productData, isEditMode)
        .then(() => {
            alert(isEditMode ? 'Producto actualizado correctamente' : 'Producto agregado correctamente');
            modal.style.display = 'none';
            loadProducts();
        })
        .catch(error => {
            console.error("Error al guardar producto:", error);
            alert('Error: ' + error.message);
        })
        .finally(() => {
            isFormSubmitting = false;
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        });
}

function editProduct(firebaseKey, category) {
    db.ref(`productos/${category}/${firebaseKey}`).once('value').then(snapshot => {
        const product = snapshot.val();
        if (product) {
            product.firebaseKey = firebaseKey;
            showProductModal(product);
        }
    });
}
function deleteProduct(firebaseKey, category) {
    if (!firebaseKey || !category) {
        alert('Error: Informaci칩n de producto incompleta');
        return;
    }
    
    db.ref(`productos/${category}/${firebaseKey}`).remove()
        .then(() => {
            alert('Producto eliminado correctamente');
            // Recargar solo la categor칤a actual en lugar de todos los productos
            if (currentProductCategory === 'all') {
                loadProducts();
            } else {
                filterProducts(currentProductCategory);
            }
        })
        .catch(error => {
            console.error('Error al eliminar producto:', error);
            alert('Error al eliminar: ' + error.message);
        });
}

function loadConfiguration() {
    db.ref('configuracion').once('value').then(snapshot => {
        const config = snapshot.val();
        if (config) {
            ['carrusel1', 'carrusel2', 'carrusel3'].forEach(carousel => {
                document.getElementById(`${carousel.replace('carrusel', 'carousel')}-text`).value = config[carousel]?.texto || '';
                document.getElementById(`${carousel.replace('carrusel', 'carousel')}-show-text`).checked = config[carousel]?.mostrarTexto || false;
                document.getElementById(`${carousel.replace('carrusel', 'carousel')}-show-carousel`).checked = config[carousel]?.mostrarCarrusel || false;
            });
        }
    });

    db.ref('bannerespecial').once('value').then(snapshot => {
        const banner = snapshot.val();
        if (banner) {
            document.getElementById('banner-active').checked = banner.activo || false;
            document.getElementById('banner-link').value = banner.link || '';
            document.getElementById('banner-pc').value = banner.pc || '';
            document.getElementById('banner-mobile').value = banner.celular || '';
        }
    });
}

function setupFormEvents() {
    // Formulario de producto - con prevenci칩n de doble env칤o
    const productForm = document.getElementById('product-form');
    if (productForm) {
        productForm.removeEventListener('submit', saveProductHandler); // Remover listeners previos
        productForm.addEventListener('submit', function(e) {
            e.preventDefault();
            saveProductHandler();
        });
    }

    // Formulario de configuraci칩n del carrusel
    const carouselForm = document.getElementById('carousel-config-form');
    if (carouselForm) {
        carouselForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const configData = {
                carrusel1: {
                    texto: document.getElementById('carousel1-text').value,
                    mostrarTexto: document.getElementById('carousel1-show-text').checked,
                    mostrarCarrusel: document.getElementById('carousel1-show-carousel').checked
                },
                carrusel2: {
                    texto: document.getElementById('carousel2-text').value,
                    mostrarTexto: document.getElementById('carousel2-show-text').checked,
                    mostrarCarrusel: document.getElementById('carousel2-show-carousel').checked
                },
                carrusel3: {
                    texto: document.getElementById('carousel3-text').value,
                    mostrarTexto: document.getElementById('carousel3-show-text').checked,
                    mostrarCarrusel: document.getElementById('carousel3-show-carousel').checked
                }
            };
            
            db.ref('configuracion').set(configData)
                .then(() => alert('Configuraci칩n del carrusel guardada correctamente'))
                .catch(error => alert('Error al guardar la configuraci칩n: ' + error.message));
        });
    }
    
    // Formulario de configuraci칩n del banner
    const bannerForm = document.getElementById('banner-config-form');
    if (bannerForm) {
        bannerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const bannerData = {
                activo: document.getElementById('banner-active').checked,
                link: document.getElementById('banner-link').value,
                pc: document.getElementById('banner-pc').value,
                celular: document.getElementById('banner-mobile').value
            };
            
            db.ref('bannerespecial').set(bannerData)
                .then(() => alert('Configuraci칩n del banner guardada correctamente'))
                .catch(error => alert('Error al guardar la configuraci칩n: ' + error.message));
        });
    }
}


// Cache para las im치genes del carrusel
let carouselImagesCache = {
    desktop: null,
    mobile: null
};

// Variable para controlar si ya se cargaron las im치genes
let carouselImagesLoaded = false;

function loadCarouselImages() {
    // Si ya se cargaron las im치genes, no volver a cargarlas
    if (carouselImagesLoaded) {
        return Promise.resolve();
    }

    const loadPromises = ['desktop', 'mobile'].map(type => {
        return db.ref(`carrusel/${type}`).once('value').then(snapshot => {
            const images = snapshot.val() || [];
            carouselImagesCache[type] = images;
            
            // Solo mostrar si la pesta침a est치 activa
            const isActiveTab = document.querySelector(`[data-carousel-tab="${type}"]`)?.classList.contains('active');
            if (isActiveTab) {
                displayCarouselImages(images, type);
            }
        }).catch(error => {
            console.error(`Error cargando im치genes ${type}:`, error);
            carouselImagesCache[type] = []; // Cache vac칤o en caso de error
        });
    });

    return Promise.all(loadPromises).then(() => {
        carouselImagesLoaded = true;
    });
}

function displayCarouselImages(images, type) {
    const container = document.getElementById(`${type}-carousel-images`);
    if (!container) return;
    
    container.innerHTML = '';
    
    if (images && images.length > 0) {
        images.forEach((imageData, index) => {
            const card = document.createElement('div');
            card.className = 'carousel-image-card';
            card.innerHTML = `
                <img src="${imageData.url}" class="carousel-image" alt="${imageData.alt || 'Imagen carrusel'}">
                <div class="carousel-image-url">${imageData.url}</div>
                <div class="carousel-image-meta">
                    <span>Alt: ${imageData.alt}</span>
                    <span>Link: ${imageData.link}</span>
                </div>
                <div class="carousel-image-actions">
                    <button class="btn btn-primary btn-sm edit-carousel-image" data-type="${type}" data-index="${index}">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm delete-carousel-image" data-type="${type}" data-index="${index}">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            `;
            container.appendChild(card);
        });
        setupCarouselImageButtons(type);
    } else {
        container.innerHTML = '<p>No hay im치genes en este carrusel.</p>';
    }
}

function setupCarouselTabs() {
    document.querySelectorAll('[data-carousel-tab]').forEach(tab => {
        tab.addEventListener('click', function() {
            // Evitar m칰ltiples clicks
            if (this.classList.contains('active')) return;
            
            const tabType = this.getAttribute('data-carousel-tab');
            
            // Cambio INMEDIATO de UI - sin esperar nada
            document.querySelectorAll('[data-carousel-tab]').forEach(t => {
                t.classList.remove('active');
            });
            this.classList.add('active');
            
            // Ocultar todos los contenidos inmediatamente
            document.getElementById('carousel-desktop-content').classList.remove('active');
            document.getElementById('carousel-mobile-content').classList.remove('active');
            
            // Mostrar el contenido seleccionado inmediatamente
            document.getElementById(`carousel-${tabType}-content`).classList.add('active');
            
            // Ocultar mensaje por defecto inmediatamente
            const defaultMessage = document.getElementById('carousel-default-message');
            if (defaultMessage) {
                defaultMessage.style.display = 'none';
            }
            
            // Verificar si necesitamos mostrar las im치genes del cache
            if (carouselImagesCache[tabType]) {
                // Si ya tenemos las im치genes en cache, mostrarlas inmediatamente
                displayCarouselImages(carouselImagesCache[tabType], tabType);
            } else if (!carouselImagesLoaded) {
                // Solo si no hay cache Y no se han cargado, mostrar contenido vac칤o primero
                const container = document.getElementById(`${tabType}-carousel-images`);
                if (container) {
                    container.innerHTML = '<div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando im치genes...</div>';
                }
            }
        });
    });
}

function setupCarouselAddButtons() {
    document.getElementById('add-desktop-image')?.addEventListener('click', () => addCarouselImage('desktop'));
    document.getElementById('add-mobile-image')?.addEventListener('click', () => addCarouselImage('mobile'));
}

function setupCarouselModal() {
    const modal = document.getElementById('carousel-image-modal');
    
    document.getElementById('cancel-edit-carousel')?.addEventListener('click', () => {
        modal.style.display = 'none';
    });
    
    const editForm = document.getElementById('edit-carousel-image-form');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const type = document.getElementById('edit-carousel-type').value;
            const index = parseInt(document.getElementById('edit-carousel-index').value);
            
            const updatedData = {
                url: document.getElementById('edit-carousel-url').value,
                alt: document.getElementById('edit-carousel-alt').value,
                link: document.getElementById('edit-carousel-link').value
            };
            
            // Actualizar cache local primero para respuesta inmediata
            if (carouselImagesCache[type] && carouselImagesCache[type][index]) {
                carouselImagesCache[type][index] = updatedData;
                displayCarouselImages(carouselImagesCache[type], type);
            }
            
            // Luego actualizar en Firebase
            db.ref(`carrusel/${type}`).once('value').then(snapshot => {
                const images = snapshot.val() || [];
                images[index] = updatedData;
                return db.ref(`carrusel/${type}`).set(images);
            }).then(() => {
                alert('Imagen actualizada correctamente');
                modal.style.display = 'none';
            }).catch(error => {
                alert('Error al actualizar la imagen: ' + error.message);
                // Recargar en caso de error
                forceReloadCarouselImages();
            });
        });
    }
}

function setupCarouselImageButtons(type) {
    document.querySelectorAll(`.edit-carousel-image[data-type="${type}"]`).forEach(btn => {
        btn.addEventListener('click', function() {
            editCarouselImage(this.getAttribute('data-type'), parseInt(this.getAttribute('data-index')));
        });
    });
    
    document.querySelectorAll(`.delete-carousel-image[data-type="${type}"]`).forEach(btn => {
        btn.addEventListener('click', function() {
            deleteCarouselImage(this.getAttribute('data-type'), parseInt(this.getAttribute('data-index')));
        });
    });
}

function editCarouselImage(type, index) {
    // Usar cache si est치 disponible
    if (carouselImagesCache[type] && carouselImagesCache[type][index]) {
        const imageData = carouselImagesCache[type][index];
        showEditModal(type, index, imageData);
    } else {
        // Fallback a Firebase si no hay cache
        db.ref(`carrusel/${type}`).once('value').then(snapshot => {
            const images = snapshot.val() || [];
            if (images[index]) {
                showEditModal(type, index, images[index]);
            }
        });
    }
}

function showEditModal(type, index, imageData) {
    const modal = document.getElementById('carousel-image-modal');
    document.getElementById('edit-carousel-type').value = type;
    document.getElementById('edit-carousel-index').value = index;
    document.getElementById('edit-carousel-url').value = imageData.url;
    document.getElementById('edit-carousel-alt').value = imageData.alt || '';
    document.getElementById('edit-carousel-link').value = imageData.link || '';
    modal.style.display = 'flex';
}

function deleteCarouselImage(type, index) {
    const modal = document.getElementById('delete-confirmation-modal');
    
    document.getElementById('cancel-delete').onclick = () => modal.style.display = 'none';
    
    document.getElementById('confirm-delete').onclick = () => {
        modal.style.display = 'none';
        
        // Actualizar cache local primero
        if (carouselImagesCache[type]) {
            carouselImagesCache[type].splice(index, 1);
            displayCarouselImages(carouselImagesCache[type], type);
        }
        
        // Luego actualizar Firebase
        db.ref(`carrusel/${type}`).once('value').then(snapshot => {
            const images = snapshot.val() || [];
            images.splice(index, 1);
            return db.ref(`carrusel/${type}`).set(images);
        }).then(() => {
            alert('Imagen eliminada correctamente');
        }).catch(error => {
            alert('Error al eliminar la imagen: ' + error.message);
            // Recargar en caso de error
            forceReloadCarouselImages();
        });
    };
    
    modal.style.display = 'flex';
}

function addCarouselImage(type) {
    const modal = document.getElementById('add-image-modal');
    document.getElementById('add-carousel-type').value = type;
    
    document.getElementById('new-carousel-url').value = '';
    document.getElementById('new-carousel-alt').value = '';
    document.getElementById('new-carousel-link').selectedIndex = 0;
    
    document.getElementById('add-carousel-image-form').onsubmit = function(e) {
        e.preventDefault();
        
        const url = document.getElementById('new-carousel-url').value;
        const alt = document.getElementById('new-carousel-alt').value;
        const link = document.getElementById('new-carousel-link').value;
        
        if (url) {
            const newImage = { url, alt: alt || '', link: link || '' };
            
            const submitBtn = document.querySelector('#add-carousel-image-form [type="submit"]');
            const originalBtnText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            
            // Actualizar cache local primero
            if (!carouselImagesCache[type]) {
                carouselImagesCache[type] = [];
            }
            carouselImagesCache[type].push(newImage);
            displayCarouselImages(carouselImagesCache[type], type);
            
            // Luego actualizar Firebase
            db.ref(`carrusel/${type}`).once('value').then(snapshot => {
                const images = snapshot.val() || [];
                images.push(newImage);
                return db.ref(`carrusel/${type}`).set(images);
            }).then(() => {
                modal.style.display = 'none';
                alert('Imagen agregada correctamente');
            }).catch(error => {
                alert('Error al agregar la imagen: ' + error.message);
                // Recargar en caso de error
                forceReloadCarouselImages();
            }).finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
            });
        } else {
            alert('La URL de la imagen es requerida');
        }
    };
    
    document.getElementById('cancel-add-carousel').onclick = () => modal.style.display = 'none';
    modal.style.display = 'flex';
}

// Funci칩n para forzar recarga cuando hay errores
function forceReloadCarouselImages() {
    carouselImagesLoaded = false;
    carouselImagesCache = { desktop: null, mobile: null };
    loadCarouselImages();
}

// Funci칩n para inicializar todo (llamar cuando se carga la p치gina)
function initializeCarousel() {
    setupCarouselTabs();
    setupCarouselAddButtons();
    setupCarouselModal();
    
    // CARGA INMEDIATA al inicializar - no esperar clicks
    loadCarouselImages().then(() => {
        console.log('Im치genes del carrusel cargadas exitosamente');
    }).catch(error => {
        console.error('Error cargando im치genes del carrusel:', error);
    });
}




// ===== FUNCIONES PARA D칈AS CLAUSURADOS =====

// Cargar todos los d칤as clausurados
function loadDiasClausurados() {
    db.ref('dias-clausurados').once('value').then(snapshot => {
        const diasData = snapshot.val();
        if (diasData) displayDiasClausurados(diasData);
    }).catch(error => console.error("Error al cargar d칤as clausurados:", error));
}

// Mostrar d칤as clausurados en la grid
function displayDiasClausurados(diasData) {
    const diasGrid = document.getElementById('dias-clausurados-grid');
    if (!diasGrid) return;
    
    diasGrid.innerHTML = '';
    
    // Convertir el objeto a array y ordenar por fecha
    const diasArray = Object.keys(diasData).map(key => ({
        firebaseKey: key,
        fecha: key,
        motivo: diasData[key].motivo || 'Sin motivo especificado'
    })).sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
    
    diasArray.forEach(dia => {
        const diaCard = document.createElement('div');
        diaCard.className = 'product-card';
        diaCard.innerHTML = `
            <div class="product-image" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                <i class="fas fa-calendar-times"></i>
            </div>
            <div class="product-info">
                <div class="product-name">${formatDateForDisplay(dia.fecha)}</div>
                <div class="product-description">${dia.motivo}</div>
                <div class="product-price">D칤a clausurado</div>
                <div class="product-actions">
                    <button class="btn btn-primary btn-sm edit-dia-clausurado-btn" data-key="${dia.firebaseKey}">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm delete-dia-clausurado-btn" data-key="${dia.firebaseKey}">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        `;
        diasGrid.appendChild(diaCard);
    });
    
    if (diasArray.length === 0) {
        diasGrid.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No hay d칤as clausurados configurados</p>';
    }
}

// Funci칩n para formatear fecha para mostrar
function formatDateForDisplay(dateStr) {
    const date = new Date(dateStr + 'T00:00:00');
    return date.toLocaleDateString('es-ES', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

// Mostrar modal para agregar/editar d칤a clausurado
function showDiaClausuradoModal(dia = null) {
    const modal = document.getElementById('dia-clausurado-modal');
    const form = document.getElementById('dia-clausurado-form');
    const modalTitle = document.getElementById('dia-clausurado-modal-title');
    const firebaseKeyField = document.getElementById('dia-clausurado-firebase-key');
    
    if (!modal) {
        alert('Modal de d칤a clausurado no encontrado. Verifica el HTML.');
        return;
    }
    
    form.reset();
    
    // Configurar Flatpickr
    const fechaInput = document.getElementById('dia-clausurado-fecha');
    
    // Destruir instancia previa si existe
    if (fechaInput._flatpickr) {
        fechaInput._flatpickr.destroy();
    }
    
    // Crear nueva instancia de Flatpickr
    flatpickr(fechaInput, {
        locale: "es",
        dateFormat: "Y-m-d",
        minDate: "today",
        allowInput: false
    });
    
    if (dia) {
        modalTitle.textContent = 'Editar D칤a Clausurado';
        firebaseKeyField.value = dia.firebaseKey || '';
        fechaInput.value = dia.fecha || '';
        document.getElementById('dia-clausurado-motivo').value = dia.motivo || '';
    } else {
        modalTitle.textContent = 'Agregar D칤a Clausurado';
        firebaseKeyField.value = '';
    }
    
    modal.style.display = 'flex';
}

// Guardar d칤a clausurado
function saveDiaClausurado(diaData, isEditMode) {
    const fecha = diaData.fecha;
    const motivo = diaData.motivo;
    
    if (isEditMode) {
        // Si estamos editando, actualizar en la misma key
        return db.ref(`dias-clausurados/${diaData.firebaseKey}`).set({ motivo: motivo });
    } else {
        // Si es nuevo, usar la fecha como key y verificar que no exista
        return db.ref(`dias-clausurados/${fecha}`).once('value').then(snapshot => {
            if (snapshot.exists()) {
                throw new Error('Ya existe un d칤a clausurado para esta fecha');
            } else {
                return db.ref(`dias-clausurados/${fecha}`).set({ motivo: motivo });
            }
        });
    }
}


function saveDiaClausuradoHandler() {
    if (isFormSubmitting) return;
    
    const modal = document.getElementById('dia-clausurado-modal');
    const firebaseKey = document.getElementById('dia-clausurado-firebase-key').value;
    const isEditMode = !!firebaseKey;
    
    const diaData = {
        fecha: document.getElementById('dia-clausurado-fecha').value,
        motivo: document.getElementById('dia-clausurado-motivo').value.trim(),
        firebaseKey: firebaseKey || null
    };

    if (!diaData.fecha || !diaData.motivo) {
        alert('Por favor complete todos los campos requeridos');
        return;
    }

    // Validar que la fecha no sea en el pasado (solo para nuevos)
    if (!isEditMode) {
        const selectedDate = new Date(diaData.fecha + 'T00:00:00');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (selectedDate < today) {
            alert('No puedes clausurar fechas del pasado');
            return;
        }
    }

    isFormSubmitting = true;
    const submitBtn = document.querySelector('#dia-clausurado-form [type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

    saveDiaClausurado(diaData, isEditMode)
        .then(() => {
            alert(isEditMode ? 'D칤a clausurado actualizado correctamente' : 'D칤a clausurado agregado correctamente');
            modal.style.display = 'none';
            loadDiasClausurados();
        })
        .catch(error => {
            console.error("Error al guardar d칤a clausurado:", error);
            alert('Error: ' + error.message);
        })
        .finally(() => {
            isFormSubmitting = false;
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        });
}

// Editar d칤a clausurado
function editDiaClausurado(firebaseKey) {
    db.ref(`dias-clausurados/${firebaseKey}`).once('value').then(snapshot => {
        const dia = snapshot.val();
        if (dia) {
            const diaData = {
                firebaseKey: firebaseKey,
                fecha: firebaseKey, // La key es la fecha
                motivo: dia.motivo
            };
            showDiaClausuradoModal(diaData);
        }
    });
}

// Eliminar d칤a clausurado
function deleteDiaClausurado(firebaseKey) {
    db.ref(`dias-clausurados/${firebaseKey}`).remove()
        .then(() => {
            alert('D칤a clausurado eliminado correctamente');
            loadDiasClausurados();
        })
        .catch(error => alert('Error al eliminar: ' + error.message));
}

// Configuraci칩n de eventos para d칤as clausurados
function setupDiasClausuradosEvents() {
    // Event delegation para d칤as clausurados
    const diasGrid = document.getElementById('dias-clausurados-grid');
    if (diasGrid) {
        diasGrid.addEventListener('click', function(e) {
            const editBtn = e.target.closest('.edit-dia-clausurado-btn');
            const deleteBtn = e.target.closest('.delete-dia-clausurado-btn');
            
            if (editBtn) {
                editDiaClausurado(editBtn.getAttribute('data-key'));
            }
            if (deleteBtn && confirm('쮼st치s seguro de que deseas eliminar este d칤a clausurado?')) {
                deleteDiaClausurado(deleteBtn.getAttribute('data-key'));
            }
        });
    }

    // Bot칩n para agregar
    document.getElementById('add-dia-clausurado-btn')?.addEventListener('click', () => showDiaClausuradoModal());

    // Botones para cancelar modal
    document.getElementById('cancel-dia-clausurado-btn')?.addEventListener('click', () => {
        document.getElementById('dia-clausurado-modal').style.display = 'none';
    });
    
    document.getElementById('cancel-dia-clausurado-btn-2')?.addEventListener('click', () => {
        document.getElementById('dia-clausurado-modal').style.display = 'none';
    });

    // Formulario
    document.getElementById('dia-clausurado-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        saveDiaClausuradoHandler();
    });
}

// Control del cat치logo especial
function setupSpecialCatalogControl() {
    const toggle = document.getElementById('toggle-special-catalog');
    const statusText = document.getElementById('special-catalog-status');
    const currentStatus = document.getElementById('special-catalog-current-status');
    
    if (!toggle || !statusText) return;
    
    db.ref('config/catalogoEspecial').on('value', (snapshot) => {
        const isOpen = snapshot.val() === true;
        
        toggle.checked = isOpen;
        statusText.textContent = isOpen ? 'ABIERTO' : 'CERRADO';
        currentStatus.textContent = isOpen ? 'ABIERTO' : 'CERRADO';
        currentStatus.className = isOpen ? 'status-tag open' : 'status-tag closed';
    });
    
    toggle.addEventListener('change', (e) => {
        const newStatus = e.target.checked;
        
        statusText.textContent = newStatus ? 'Abriendo...' : 'Cerrando...';
        
        db.ref('config').update({
            catalogoEspecial: newStatus
        }).then(() => {
            statusText.textContent = newStatus ? 'ABIERTO' : 'CERRADO';
            currentStatus.textContent = newStatus ? 'ABIERTO' : 'CERRADO';
            currentStatus.className = newStatus ? 'status-tag open' : 'status-tag closed';
            alert(`Cat치logo especial ${newStatus ? 'abierto' : 'cerrado'} correctamente`);
        }).catch(error => {
            console.error("Error al cambiar estado:", error);
            statusText.textContent = 'Error';
            alert('Error al cambiar el estado');
            toggle.checked = !newStatus;
        });
    });
}

// Configuraci칩n del overlay
function loadOverlayConfig() {
    const form = document.getElementById('overlay-message-form');
    if (!form) return;

    const titleField = document.getElementById('overlay-title-admin');
    const messageField = document.getElementById('overlay-message-admin');

    db.ref('config/catalogoMensaje').once('value').then(snapshot => {
        const config = snapshot.val() || {};
        if (titleField) titleField.value = config.title || '';
        if (messageField) messageField.value = config.message || '';
    }).catch(error => {
        console.error("Error al cargar configuraci칩n:", error);
    });

    // Configurar evento del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const config = {
            title: document.getElementById('overlay-title-admin').value,
            message: document.getElementById('overlay-message-admin').value
        };

        db.ref('config/catalogoMensaje').set(config)
            .then(() => alert("Mensaje guardado correctamente"))
            .catch(error => alert("Error: " + error.message));
    });
}

// Funciones auxiliares
function getStatusClass(status) {
    const statusMap = {
        'Por realizar': 'pending',
        'Pago': 'pago',
        'Entregado': 'delivered', 
        'Aplazado': 'cancelled'
    };
    return statusMap[status] || '';
}

function filterOrders(status) {
    // Implementar filtrado de 칩rdenes seg칰n sea necesario
    console.log('Filtrar 칩rdenes por:', status);
}

function showOrderDetails(orderId) {
    // Implementar detalles de orden seg칰n sea necesario
    console.log('Mostrar detalles de orden:', orderId);
}



// ===== FUNCIONES PARA ADICIONES =====

// Cargar todas las adiciones
function loadAdiciones() {
    db.ref('adiciones').once('value').then(snapshot => {
        const adicionesData = snapshot.val();
        if (adicionesData) displayAdiciones(adicionesData);
    }).catch(error => console.error("Error al cargar adiciones:", error));
}

// Mostrar adiciones en la grid
function displayAdiciones(adicionesData) {
    const adicionesGrid = document.getElementById('adiciones-grid');
    if (!adicionesGrid) return;
    
    adicionesGrid.innerHTML = '';
    
    Object.keys(adicionesData).forEach(key => {
        const adicion = adicionesData[key];
        if (!adicion) return;
        
        const adicionCard = document.createElement('div');
        adicionCard.className = 'product-card';
        adicionCard.innerHTML = `
            <div class="product-image" style="background-image: url('${adicion.imagen || ''}')"></div>
            <div class="product-info">
                <div class="product-name">${adicion.nombre || 'Sin nombre'}</div>
                <div class="product-description">${adicion.descripcion || ''}</div>
                <div class="product-price">$${(adicion.precio || 0).toLocaleString()}</div>
                <div class="product-actions">
                    <button class="btn btn-primary btn-sm edit-adicion-btn" data-key="${key}">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm delete-adicion-btn" data-key="${key}">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        `;
        adicionesGrid.appendChild(adicionCard);
    });
}

// Mostrar modal para agregar/editar adici칩n
function showAdicionModal(adicion = null) {
    const modal = document.getElementById('adicion-modal');
    const form = document.getElementById('adicion-form');
    const modalTitle = document.getElementById('adicion-modal-title');
    const firebaseKeyField = document.getElementById('adicion-firebase-key');
    
    if (!modal) {
        alert('Modal de adici칩n no encontrado. Verifica el HTML.');
        return;
    }
    
    form.reset();
    
    if (adicion) {
        modalTitle.textContent = 'Editar Adici칩n';
        firebaseKeyField.value = adicion.firebaseKey || '';
        document.getElementById('adicion-nombre').value = adicion.nombre || '';
        document.getElementById('adicion-descripcion').value = adicion.descripcion || '';
        document.getElementById('adicion-precio').value = adicion.precio || '';
        document.getElementById('adicion-imagen').value = adicion.imagen || '';
    } else {
        modalTitle.textContent = 'Agregar Adici칩n';
        firebaseKeyField.value = '';
    }
    
    modal.style.display = 'flex';
}

// Guardar adici칩n
function saveAdicion(adicionData, isEditMode) {
    if (isEditMode) {
        return db.ref(`adiciones/${adicionData.firebaseKey}`).update(adicionData);
    } else {
        const newRef = db.ref('adiciones').push();
        adicionData.firebaseKey = newRef.key;
        return newRef.set(adicionData);
    }
}

// Handler para guardar adici칩n
function saveAdicionHandler() {
    if (isFormSubmitting) return;
    
    const modal = document.getElementById('adicion-modal');
    const firebaseKey = document.getElementById('adicion-firebase-key').value;
    const isEditMode = !!firebaseKey;
    
    const adicionData = {
        nombre: document.getElementById('adicion-nombre').value.trim(),
        descripcion: document.getElementById('adicion-descripcion').value.trim(),
        precio: parseFloat(document.getElementById('adicion-precio').value),
        imagen: document.getElementById('adicion-imagen').value.trim(),
        firebaseKey: firebaseKey || null
    };

    if (!adicionData.nombre || isNaN(adicionData.precio)) {
        alert('Por favor complete todos los campos requeridos');
        return;
    }

    isFormSubmitting = true;
    const submitBtn = document.querySelector('#adicion-form [type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

    saveAdicion(adicionData, isEditMode)
        .then(() => {
            alert(isEditMode ? 'Adici칩n actualizada correctamente' : 'Adici칩n agregada correctamente');
            modal.style.display = 'none';
            loadAdiciones();
        })
        .catch(error => {
            console.error("Error al guardar adici칩n:", error);
            alert('Error: ' + error.message);
        })
        .finally(() => {
            isFormSubmitting = false;
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        });
}

// Editar adici칩n
function editAdicion(firebaseKey) {
    db.ref(`adiciones/${firebaseKey}`).once('value').then(snapshot => {
        const adicion = snapshot.val();
        if (adicion) {
            adicion.firebaseKey = firebaseKey;
            showAdicionModal(adicion);
        }
    });
}

// Eliminar adici칩n
function deleteAdicion(firebaseKey) {
    db.ref(`adiciones/${firebaseKey}`).remove()
        .then(() => {
            alert('Adici칩n eliminada correctamente');
            loadAdiciones();
        })
        .catch(error => alert('Error al eliminar: ' + error.message));
}

// ===== FUNCIONES PARA GLOBOS =====

// Cargar todos los globos
function loadGlobos() {
    db.ref('globos').once('value').then(snapshot => {
        const globosData = snapshot.val();
        if (globosData) displayGlobos(globosData);
    }).catch(error => console.error("Error al cargar globos:", error));
}

// Mostrar globos en la grid
function displayGlobos(globosData) {
    const globosGrid = document.getElementById('globos-grid');
    if (!globosGrid) return;
    
    globosGrid.innerHTML = '';
    
    Object.keys(globosData).forEach(key => {
        const globo = globosData[key];
        if (!globo) return;
        
        const globoCard = document.createElement('div');
        globoCard.className = 'product-card';
        globoCard.innerHTML = `
            <div class="product-image" style="background-image: url('${globo.imagen || ''}')"></div>
            <div class="product-info">
                <div class="product-name">${globo.nombre || 'Sin nombre'}</div>
              <div class="product-price">$${(globo.precio || 0).toLocaleString()}</div>
<div class="product-category-badge">${globo.tipo || 'Sin tipo'}</div>
                <div class="product-actions">
                    <button class="btn btn-primary btn-sm edit-globo-btn" data-key="${key}">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-danger btn-sm delete-globo-btn" data-key="${key}">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        `;
        globosGrid.appendChild(globoCard);
    });
}

// Mostrar modal para agregar/editar globo
function showGloboModal(globo = null) {
    const modal = document.getElementById('globo-modal');
    const form = document.getElementById('globo-form');
    const modalTitle = document.getElementById('globo-modal-title');
    const firebaseKeyField = document.getElementById('globo-firebase-key');
    
    
    if (!modal) {
        alert('Modal de globo no encontrado. Verifica el HTML.');
        return;
    }
    
    form.reset();
    
    if (globo) {
        modalTitle.textContent = 'Editar Globo';
        firebaseKeyField.value = globo.firebaseKey || '';
        document.getElementById('globo-nombre').value = globo.nombre || '';
        document.getElementById('globo-tipo').value = globo.tipo || '';
        document.getElementById('globo-precio').value = globo.precio || '';
        document.getElementById('globo-imagen').value = globo.imagen || '';
    } else {
        modalTitle.textContent = 'Agregar Globo';
        firebaseKeyField.value = '';
    }
    
    modal.style.display = 'flex';
}

// Guardar globo
function saveGlobo(globoData, isEditMode) {
    if (isEditMode) {
        return db.ref(`globos/${globoData.firebaseKey}`).update(globoData);
    } else {
        const newRef = db.ref('globos').push();
        globoData.firebaseKey = newRef.key;
        return newRef.set(globoData);
    }
}

// Handler para guardar globo
function saveGloboHandler() {
    if (isFormSubmitting) return;
    
    const modal = document.getElementById('globo-modal');
    const firebaseKey = document.getElementById('globo-firebase-key').value;
    const isEditMode = !!firebaseKey;
    
    const globoData = {
        nombre: document.getElementById('globo-nombre').value.trim(),
        tipo: document.getElementById('globo-tipo').value,
        precio: parseFloat(document.getElementById('globo-precio').value),
        imagen: document.getElementById('globo-imagen').value.trim(),
        firebaseKey: firebaseKey || null
    };

   if (!globoData.nombre || isNaN(globoData.precio) || !globoData.tipo) {
    alert('Por favor complete todos los campos requeridos');
    return;
}

    isFormSubmitting = true;
    const submitBtn = document.querySelector('#globo-form [type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

    saveGlobo(globoData, isEditMode)
        .then(() => {
            alert(isEditMode ? 'Globo actualizado correctamente' : 'Globo agregado correctamente');
            modal.style.display = 'none';
            loadGlobos();
        })
        .catch(error => {
            console.error("Error al guardar globo:", error);
            alert('Error: ' + error.message);
        })
        .finally(() => {
            isFormSubmitting = false;
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        });
}

// Editar globo
function editGlobo(firebaseKey) {
    db.ref(`globos/${firebaseKey}`).once('value').then(snapshot => {
        const globo = snapshot.val();
        if (globo) {
            globo.firebaseKey = firebaseKey;
            showGloboModal(globo);
        }
    });
}

// Eliminar globo
function deleteGlobo(firebaseKey) {
    db.ref(`globos/${firebaseKey}`).remove()
        .then(() => {
            alert('Globo eliminado correctamente');
            loadGlobos();
        })
        .catch(error => alert('Error al eliminar: ' + error.message));
}

// ===== CONFIGURACI칍N DE EVENTOS =====

// Agregar estos event listeners al setupNavigation() o DOMContentLoaded:

function setupAdicionesGlobosEvents() {
    // Event delegation para adiciones
    const adicionesGrid = document.getElementById('adiciones-grid');
    if (adicionesGrid) {
        adicionesGrid.addEventListener('click', function(e) {
            const editBtn = e.target.closest('.edit-adicion-btn');
            const deleteBtn = e.target.closest('.delete-adicion-btn');
            
            if (editBtn) {
                editAdicion(editBtn.getAttribute('data-key'));
            }
            if (deleteBtn && confirm('쮼st치s seguro de que deseas eliminar esta adici칩n?')) {
                deleteAdicion(deleteBtn.getAttribute('data-key'));
            }
        });
    }

    // Event delegation para globos
    const globosGrid = document.getElementById('globos-grid');
    if (globosGrid) {
        globosGrid.addEventListener('click', function(e) {
            const editBtn = e.target.closest('.edit-globo-btn');
            const deleteBtn = e.target.closest('.delete-globo-btn');
            
            if (editBtn) {
                editGlobo(editBtn.getAttribute('data-key'));
            }
            if (deleteBtn && confirm('쮼st치s seguro de que deseas eliminar este globo?')) {
                deleteGlobo(deleteBtn.getAttribute('data-key'));
            }
        });
    }

    // Botones para agregar
    document.getElementById('add-adicion-btn')?.addEventListener('click', () => showAdicionModal());
    document.getElementById('add-globo-btn')?.addEventListener('click', () => showGloboModal());

    // Botones para cancelar modales
    document.querySelectorAll('#cancel-adicion-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.getElementById('adicion-modal').style.display = 'none';
        });
    });
    
    document.querySelectorAll('#cancel-globo-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.getElementById('globo-modal').style.display = 'none';
        });
    });

    // Formularios
    document.getElementById('adicion-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        saveAdicionHandler();
    });

    document.getElementById('globo-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        saveGloboHandler();
    });
}

document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("modalYtxd");
  const modalImg = document.getElementById("modalImgYtxd");
  const closeBtn = document.querySelector(".close-ytxd");

  document.querySelectorAll(".open-ytxd").forEach(link => {
    link.addEventListener("click", e => {
      e.preventDefault();
      modal.style.display = "block";
      modalImg.src = link.getAttribute("href");
    });
  });

  closeBtn.addEventListener("click", () => {
    modal.style.display = "none";
  });

  modal.addEventListener("click", e => {
    if (e.target === modal) {
      modal.style.display = "none";
    }
  });
});


   </script>
</body>
</html>